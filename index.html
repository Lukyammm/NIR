<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ocorrências do Plantão – NIR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg: #f2f4f8;
      --surface: #ffffff;
      --surface-alt: #f7f8fa;
      --border: #e1e4ea;
      --text: #111318;
      --text-muted: #6b7280;
      --accent: #0a84ff;
      --accent-strong: #005bd1;
      --danger: #d70015;
      --success: #248a3d;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      --shadow-soft: 0 8px 20px rgba(15, 23, 42, 0.06);
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --spacing-xs: 6px;
      --spacing-sm: 10px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      background: rgba(255, 255, 255, 0.92);
      border-bottom: 1px solid var(--border);
      padding: var(--spacing-lg) var(--spacing-xl);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(10px);
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .menu-selector {
      position: relative;
    }

    .menu-button {
      background: var(--surface-alt);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .menu-button svg {
      width: 14px;
      height: 14px;
    }

    .menu-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-soft);
      min-width: 220px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
    }

    .menu-item {
      border: none;
      background: transparent;
      text-align: left;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text);
    }

    .menu-item:hover,
    .menu-item.active {
      background: rgba(10, 132, 255, 0.12);
      color: var(--accent-strong);
    }

    .title-stack h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .subtitle {
      margin: 0;
      color: var(--text-muted);
      font-size: 14px;
    }

    .badge {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(10, 132, 255, 0.12);
      color: var(--accent-strong);
      font-weight: 600;
      border: 1px solid rgba(10, 132, 255, 0.24);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    .app-content {
      padding: var(--spacing-xl);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    #ocorrenciasPage {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xl);
    }

    .grid {
      display: grid;
      gap: var(--spacing-lg);
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-strong);
      flex-shrink: 0;
    }

    .card-icon svg {
      width: 18px;
      height: 18px;
      opacity: 0.8;
    }

    .card-header h2 {
      margin: 0;
      font-size: 17px;
      letter-spacing: -0.01em;
    }

    .card-content {
      padding: var(--spacing-lg);
    }

    .muted {
      color: var(--text-muted);
      margin: 4px 0 0;
    }

    .report-card {
      box-shadow: var(--shadow-soft);
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--spacing-lg);
    }

    .report-column {
      background: var(--surface);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      box-shadow: var(--shadow-soft);
    }

    .report-column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-sm);
    }

    .report-column-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .report-lines {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .report-line {
      display: flex;
      gap: var(--spacing-md);
      align-items: stretch;
      padding: 16px 18px;
      border-radius: 18px;
      border: 1px solid rgba(17, 19, 24, 0.08);
      background: #ffffff;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
      position: relative;
      overflow: hidden;
    }

    .report-line::before {
      content: "";
      position: absolute;
      inset: 0 auto 0 0;
      width: 6px;
      background: var(--line-color, #0a84ff);
    }

    .report-line:last-child {
      border-bottom: 1px solid rgba(17, 19, 24, 0.08);
    }

    .report-line.locked {
      opacity: 0.82;
    }

    .report-line-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-left: 4px;
    }

    .report-line-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-sm);
    }

    .report-line-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .report-line-label {
      font-weight: 700;
    }

    .report-lock-button {
      border: none;
      background: rgba(15, 23, 42, 0.08);
      width: 30px;
      height: 30px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .report-lock-button svg {
      width: 16px;
      height: 16px;
    }

    .report-lock-button:hover {
      background: rgba(10, 132, 255, 0.16);
      color: var(--accent-strong);
    }

    .report-lock-button.is-locked {
      background: rgba(10, 132, 255, 0.2);
      color: var(--accent-strong);
    }

    .report-color-picker {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .report-color-button {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 2px solid rgba(17, 19, 24, 0.08);
      background: var(--line-color, #0a84ff);
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.5), 0 6px 12px rgba(15, 23, 42, 0.15);
      cursor: pointer;
    }

    .report-color-picker.open .report-color-palette {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }

    .report-color-palette {
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      display: grid;
      grid-template-columns: repeat(5, 28px);
      gap: 8px;
      padding: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow-soft);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-6px);
      transition: all 0.2s ease;
      z-index: 2;
      pointer-events: none;
    }

    .report-color-option,
    .report-color-generate {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.5), 0 4px 8px rgba(15, 23, 42, 0.12);
    }

    .report-color-option[disabled] {
      cursor: not-allowed;
      opacity: 0.35;
      box-shadow: none;
    }

    .report-color-generate {
      grid-column: span 5;
      height: 32px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: linear-gradient(135deg, rgba(10, 132, 255, 0.2), rgba(121, 59, 255, 0.22));
      color: var(--accent-strong);
    }

    .report-sublines {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-left: 18px;
      border-left: 1px dashed rgba(17, 19, 24, 0.12);
    }

    .report-subline {
      display: flex;
      align-items: stretch;
      gap: 8px;
      padding: 10px 12px 10px 16px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.04);
      border: 1px solid rgba(15, 23, 42, 0.08);
      position: relative;
    }

    .report-subline::before {
      content: "";
      position: absolute;
      left: 8px;
      top: 8px;
      bottom: 8px;
      width: 3px;
      border-radius: 999px;
      background: var(--line-color, #0a84ff);
    }

    .report-subline.is-nested {
      background: rgba(15, 23, 42, 0.02);
      border-color: rgba(15, 23, 42, 0.06);
      padding: 8px 10px 8px 14px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    .report-subline.is-nested::before {
      left: 6px;
      top: 6px;
      bottom: 6px;
      width: 2px;
      background: color-mix(in srgb, var(--line-color, #0a84ff) 70%, #ffffff 30%);
    }

    .report-subline-marker {
      width: 8px;
      height: 8px;
      margin-top: 10px;
      border-radius: 999px;
      background: var(--line-color, #0a84ff);
      flex-shrink: 0;
    }

    .report-subline-text {
      flex: 1;
      border: none;
      background: transparent;
      resize: vertical;
      min-height: 24px;
      font-size: 13px;
      color: var(--text);
      padding: 0;
      outline: none;
      font-family: inherit;
    }

    .report-subline-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .report-subline-input {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .report-subline-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .report-subline-remove {
      border: none;
      background: rgba(215, 0, 21, 0.12);
      color: var(--danger);
      border-radius: 10px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-weight: 700;
    }

    .report-subline-children {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-left: 14px;
      border-left: 1px dashed rgba(17, 19, 24, 0.12);
    }

    .report-add-subline.is-nested {
      font-size: 10px;
      width: 30px;
      height: 26px;
    }

    .report-add-subline svg {
      width: 16px;
      height: 16px;
    }

    .report-text {
      flex: 1;
      border: none;
      background: transparent;
      resize: vertical;
      min-height: 28px;
      font-size: 14px;
      color: var(--text);
      padding: 0;
      outline: none;
      min-height: 34px;
      font-family: inherit;
    }

    .report-add-subline {
      align-self: flex-start;
      border: none;
      background: rgba(10, 132, 255, 0.12);
      color: var(--accent-strong);
      border-radius: 10px;
      padding: 0;
      width: 34px;
      height: 30px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
    }

    .report-editor {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.04);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 12px;
      padding: 4px;
    }

    .report-editor-button {
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 11px;
      font-weight: 700;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
    }

    .report-editor-button.active {
      background: rgba(10, 132, 255, 0.2);
      color: var(--accent-strong);
    }

    .report-editor-button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .report-edit-button {
      border: none;
      background: rgba(15, 23, 42, 0.08);
      color: var(--text-muted);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
    }

    .report-edit-button.active {
      background: rgba(10, 132, 255, 0.2);
      color: var(--accent-strong);
    }

    .report-line.locked .report-text {
      color: var(--text-muted);
    }

    .report-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .report-action {
      border: 1px solid rgba(17, 19, 24, 0.08);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(243, 245, 248, 0.9));
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .report-action:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.14);
    }

    .report-action.primary {
      background: linear-gradient(135deg, rgba(10, 132, 255, 0.2), rgba(10, 132, 255, 0.05));
      color: var(--accent-strong);
    }

    .report-action[disabled] {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
      transform: none;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--spacing-md);
    }

    .info-item {
      background: var(--surface-alt);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: var(--shadow-soft);
    }

    .info-item span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--spacing-md);
    }

    .kpi {
      padding: 14px 16px;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: var(--shadow-soft);
    }

    .kpi strong {
      font-size: 24px;
      letter-spacing: -0.01em;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: var(--surface-alt);
      color: var(--text);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      min-height: 44px;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12);
    }

    .btn:focus-visible {
      outline: 3px solid rgba(0, 122, 255, 0.35);
      outline-offset: 2px;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 20px rgba(10, 132, 255, 0.25);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.05);
    }

    .btn-danger {
      background: rgba(215, 0, 21, 0.12);
      color: var(--danger);
      border-color: rgba(215, 0, 21, 0.2);
    }

    .btn-ghost {
      background: transparent;
      border-color: var(--border);
    }

    .btn-lg {
      padding: 14px 24px;
      font-size: 16px;
      min-height: 48px;
    }

    .tabs {
      display: flex;
      gap: 6px;
      background: var(--surface-alt);
      border-radius: 999px;
      padding: 6px;
      border: 1px solid var(--border);
    }

    .tab {
      border: none;
      background: transparent;
      padding: 10px 16px;
      border-radius: 999px;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 600;
    }

    .tab.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 16px rgba(10, 132, 255, 0.24);
    }

    .table-wrapper {
      padding: var(--spacing-md);
      overflow: auto;
    }

    .table-wrapper table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .table-wrapper th,
    .table-wrapper td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
    }

    .table-wrapper thead th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .table-wrapper tr:hover {
      background: rgba(0, 122, 255, 0.06);
    }

    .table-action {
      display: inline-flex;
      gap: 6px;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      padding: 12px 14px;
      min-height: 46px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: #f5f6f7;
      color: var(--text);
      font-size: 15px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      outline: 3px solid rgba(0, 122, 255, 0.3);
      border-color: var(--accent);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }

    .field-textarea {
      grid-column: 1 / -1;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
      z-index: 20;
      padding: var(--spacing-lg);
    }

    .modal-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 16px;
      border: 1px solid var(--border);
      max-width: 760px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 28px 60px rgba(15, 23, 42, 0.2), 0 8px 18px rgba(15, 23, 42, 0.08);
      opacity: 0;
      transform: translateY(12px) scale(0.98);
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .modal-header,
    .modal-footer {
      padding: var(--spacing-lg) var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
    }

    .modal-backdrop.active .modal {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .modal-title {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .modal-subtitle {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .modal-close {
      border: none;
      background: rgba(17, 24, 39, 0.08);
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(17, 24, 39, 0.12);
      transform: translateY(-1px);
    }

    .modal-close svg {
      width: 16px;
      height: 16px;
    }

    .modal-footer {
      padding-top: var(--spacing-md);
      padding-bottom: var(--spacing-lg);
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      justify-content: flex-end;
      gap: var(--spacing-sm);
    }

    .modal-body {
      padding: 0 var(--spacing-lg) var(--spacing-lg);
      overflow: auto;
    }

    .modal-stack {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .modal-section {
      background: rgba(248, 249, 251, 0.9);
      border-radius: 14px;
      padding: var(--spacing-md);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .modal-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .modal-body .field span {
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 0.01em;
      text-transform: uppercase;
    }

    .textarea {
      min-height: 120px;
      background: #f2f3f5;
    }

    .btn-primary {
      background: linear-gradient(180deg, #0a84ff, #0062d1);
    }

    .modal-footer .btn-primary {
      min-width: 200px;
    }

    .btn.is-loading {
      opacity: 0.72;
      cursor: progress;
      box-shadow: none;
      transform: none;
    }

    .btn.is-loading::after {
      content: "•";
      margin-left: 8px;
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%,
      100% {
        opacity: 0.4;
      }
      50% {
        opacity: 1;
      }
    }

    @media (max-width: 720px) {
      .modal-backdrop {
        padding: var(--spacing-md);
      }

      .modal {
        max-width: 100%;
        max-height: 94vh;
        border-radius: 18px;
      }

      .modal-footer {
        flex-direction: column;
        align-items: stretch;
      }

      .modal-footer .btn-primary {
        width: 100%;
      }
    }

    .toast-container {
      position: fixed;
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 30;
    }

    .toast {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      font-weight: 600;
    }

    .toast.success {
      border-color: rgba(36, 138, 61, 0.4);
      color: var(--success);
    }

    .toast.error {
      border-color: rgba(215, 0, 21, 0.4);
      color: var(--danger);
    }

    .toast.info {
      border-color: rgba(0, 122, 255, 0.4);
      color: var(--accent);
    }

    .loader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: #fff;
      font-weight: 600;
      z-index: 40;
    }

    .loader.hidden {
      display: none;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(255, 255, 255, 0.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .skeleton {
      animation: pulse 1.5s ease-in-out infinite;
      background: linear-gradient(90deg, rgba(200, 200, 200, 0.2), rgba(200, 200, 200, 0.4), rgba(200, 200, 200, 0.2));
      border-radius: var(--radius-md);
      height: 14px;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .app-header {
        padding: var(--spacing-md);
      }

      .app-content {
        padding: var(--spacing-md);
      }

      .tabs {
        flex-wrap: wrap;
      }

      .header-actions {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="app-header">
      <div class="header-title">
        <div class="menu-selector">
          <button id="menuToggle" class="menu-button" type="button">
            <span id="menuLabel">Ocorrências</span>
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div id="menuDropdown" class="menu-dropdown hidden">
            <button class="menu-item active" data-page="ocorrencias">Ocorrências NIR</button>
            <button class="menu-item" data-page="relatorio">Relatório</button>
          </div>
        </div>
        <div class="title-stack">
          <h1 id="pageTitle">Ocorrências do Plantão</h1>
          <p id="pageSubtitle" class="subtitle">Núcleo Interno de Regulação (NIR)</p>
        </div>
        <span id="statusBadge" class="badge">Sem plantão ativo</span>
      </div>
      <div class="header-actions">
        <button id="btnRefresh" class="btn btn-ghost btn-lg">Atualizar</button>
        <button id="btnStartShift" class="btn btn-primary btn-lg">Iniciar plantão</button>
        <button id="btnEndShift" class="btn btn-danger btn-lg">Encerrar plantão</button>
      </div>
    </header>

    <main class="app-content">
      <div id="ocorrenciasPage">
        <section class="grid grid-2">
        <article class="card">
          <header class="card-header">
            <div class="card-title">
              <span class="card-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M8 7h8M7 11h10M8 15h8M6 3h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <h2>Plantão ativo</h2>
                <p class="muted" id="shiftSummary">Nenhum plantão ativo.</p>
              </div>
            </div>
            <button id="btnEditShift" class="btn btn-secondary">Equipe do plantão</button>
          </header>
          <div class="card-content">
            <div class="info-grid">
              <div class="info-item"><span>Data</span><strong id="infoData">-</strong></div>
              <div class="info-item"><span>Dia</span><strong id="infoDia">-</strong></div>
              <div class="info-item"><span>Turno</span><strong id="infoTurno">-</strong></div>
              <div class="info-item"><span>Médico(a) 1</span><strong id="infoMed1">-</strong></div>
              <div class="info-item"><span>Médico(a) 2</span><strong id="infoMed2">-</strong></div>
              <div class="info-item"><span>Enfermeiro(a) 1</span><strong id="infoEnf1">-</strong></div>
              <div class="info-item"><span>Enfermeiro(a) 2</span><strong id="infoEnf2">-</strong></div>
              <div class="info-item"><span>Auxiliar</span><strong id="infoAux">-</strong></div>
            </div>
          </div>
        </article>

        <article class="card">
          <header class="card-header">
            <div class="card-title">
              <span class="card-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 19h16M7 16V9M12 16V5M17 16v-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <h2>Indicadores do plantão</h2>
                <p class="muted">Atualizados automaticamente</p>
              </div>
            </div>
          </header>
          <div class="card-content">
            <div class="kpi-grid">
              <div class="kpi">
                <span>Alocados</span>
                <strong id="kpiAlocados">0</strong>
              </div>
              <div class="kpi">
                <span>Reservas confirmadas</span>
                <strong id="kpiConfirmadas">0</strong>
              </div>
              <div class="kpi">
                <span>Reservas canceladas</span>
                <strong id="kpiCanceladas">0</strong>
              </div>
              <div class="kpi">
                <span>Admitidos UIB</span>
                <strong id="kpiAdmitidos">0</strong>
              </div>
            </div>
          </div>
        </article>
      </section>

        <section class="card">
          <header class="card-header">
            <div class="card-title">
              <span class="card-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M8.5 12.5l2.3 2.3L15.5 10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M6 3h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <h2 id="principalTitle">Reservas confirmadas</h2>
                <p class="muted" id="principalSubtitle">Pacientes com reserva confirmada para UIB</p>
              </div>
            </div>
            <div class="header-actions">
              <div class="tabs">
                <button class="tab active" data-view="confirmadas">Confirmadas</button>
                <button class="tab" data-view="vascular">Vascular</button>
                <button class="tab" data-view="negadas">Negadas</button>
                <button class="tab" data-view="anterior">Plantão anterior</button>
              </div>
              <button id="btnAddPrincipal" class="btn btn-primary">Adicionar registro</button>
            </div>
          </header>
          <div id="principalTable" class="table-wrapper"></div>
        </section>

        <section class="grid grid-2">
          <article class="card">
            <header class="card-header">
              <div class="card-title">
                <span class="card-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M14.5 6.5l3 3-7.6 7.6H7v-2.9L14.5 6.5Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M13 5l2-2 4 4-2 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                <div>
                  <h2>Bloqueios de manutenção</h2>
                  <p class="muted">Leitos temporariamente indisponíveis</p>
                </div>
              </div>
              <button id="btnAddManutencao" class="btn btn-secondary">Adicionar</button>
            </header>
            <div id="manutencaoTable" class="table-wrapper"></div>
          </article>

          <article class="card">
            <header class="card-header">
              <div class="card-title">
                <span class="card-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M7 10V8a5 5 0 0 1 10 0v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 10h12a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                <div>
                  <h2>Bloqueios de isolamento</h2>
                  <p class="muted">Leitos reservados por isolamento</p>
                </div>
              </div>
              <button id="btnAddIsolamento" class="btn btn-secondary">Adicionar</button>
            </header>
            <div id="isolamentoTable" class="table-wrapper"></div>
          </article>
        </section>
      </div>

      <div id="relatorioPage" class="hidden">
        <section class="card report-card">
          <header class="card-header">
            <div>
              <h2>Relatório das Ocorrências do Plantão</h2>
              <p class="muted">Conteúdo contínuo entre plantões, com travamento por linha.</p>
            </div>
          </header>
          <div class="card-content">
            <div class="report-grid">
              <div class="report-column" data-column="enfermagem">
                <div class="report-column-header">
                  <h3>Enfermagem</h3>
                  <button class="btn btn-ghost" data-action="add-line" data-column="enfermagem">Adicionar linha</button>
                </div>
                <div class="report-lines" id="reportEnfermagem"></div>
              </div>

              <div class="report-column" data-column="medica">
                <div class="report-column-header">
                  <h3>Médica</h3>
                  <button class="btn btn-ghost" data-action="add-line" data-column="medica">Adicionar linha</button>
                </div>
                <div class="report-lines" id="reportMedica"></div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div id="modalShift" class="modal-backdrop">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h3 class="modal-title">Equipe do plantão</h3>
          <p class="modal-subtitle">Defina a data, o turno e a equipe responsável.</p>
        </div>
        <button class="modal-close" type="button" data-close="modalShift" aria-label="Fechar modal">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6L18 18M6 18L18 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </button>
      </header>
      <div class="modal-body">
        <div class="modal-stack">
          <section class="modal-section">
            <div class="modal-section-title">Identificação do plantão</div>
            <div class="form-grid">
              <label class="field">
                <span>Data do plantão</span>
                <input class="input" type="date" id="shiftData">
              </label>
              <label class="field">
                <span>Turno</span>
                <select class="select" id="shiftTurno">
                  <option value="">Selecione</option>
                  <option value="MT">MT</option>
                  <option value="SN">SN</option>
                </select>
              </label>
            </div>
          </section>
          <section class="modal-section">
            <div class="modal-section-title">Equipe assistencial</div>
            <div class="form-grid">
              <label class="field">
                <span>Médico(a) 1</span>
                <input class="input" type="text" id="shiftMed1">
              </label>
              <label class="field">
                <span>Médico(a) 2</span>
                <input class="input" type="text" id="shiftMed2">
              </label>
              <label class="field">
                <span>Enfermeiro(a) 1</span>
                <input class="input" type="text" id="shiftEnf1">
              </label>
              <label class="field">
                <span>Enfermeiro(a) 2</span>
                <input class="input" type="text" id="shiftEnf2">
              </label>
              <label class="field">
                <span>Auxiliar administrativo</span>
                <input class="input" type="text" id="shiftAux">
              </label>
            </div>
          </section>
        </div>
      </div>
      <footer class="modal-footer">
        <button class="btn btn-secondary" type="button" data-close="modalShift">Cancelar</button>
        <button id="btnSaveShift" class="btn btn-primary">Salvar</button>
      </footer>
    </div>
  </div>

  <div id="modalRecord" class="modal-backdrop">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h3 class="modal-title" id="recordTitle">Novo registro</h3>
          <p class="modal-subtitle">Preencha as informações com atenção antes de salvar.</p>
        </div>
        <button class="modal-close" type="button" data-close="modalRecord" aria-label="Fechar modal">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6L18 18M6 18L18 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </button>
      </header>
      <div class="modal-body">
        <div id="recordFields" class="modal-stack"></div>
      </div>
      <footer class="modal-footer">
        <button class="btn btn-secondary" type="button" data-close="modalRecord">Cancelar</button>
        <button id="btnSaveRecord" class="btn btn-primary">Salvar registro</button>
      </footer>
    </div>
  </div>

  <div id="toastContainer" class="toast-container"></div>
  <div id="loader" class="loader hidden">
    <div class="spinner"></div>
    <span id="loaderText">Salvando...</span>
  </div>

  <script>
    const Api = (() => {
      const run = (name, payload) => new Promise((resolve, reject) => {
        if (typeof google === "undefined" || !google.script || !google.script.run) {
          reject(new Error("google.script.run não disponível."));
          return;
        }

        const runner = google.script.run
          .withSuccessHandler((response) => {
            if (response && response.ok) {
              resolve(response.data);
            } else {
              const message = response && response.error ? response.error.message : "Erro desconhecido";
              reject(new Error(message));
            }
          })
          .withFailureHandler((err) => {
            reject(err);
          });

        if (payload === undefined) {
          runner[name]();
        } else {
          runner[name](payload);
        }
      });

      const runWithArgs = (name, args) => new Promise((resolve, reject) => {
        if (typeof google === "undefined" || !google.script || !google.script.run) {
          reject(new Error("google.script.run não disponível."));
          return;
        }

        const runner = google.script.run
          .withSuccessHandler((response) => {
            if (response && response.ok) {
              resolve(response.data);
            } else {
              const message = response && response.error ? response.error.message : "Erro desconhecido";
              reject(new Error(message));
            }
          })
          .withFailureHandler((err) => {
            reject(err);
          });

        runner[name].apply(runner, args);
      });

      return {
        getAppState: () => run("getAppState"),
        startShift: (payload) => run("startShift", payload),
        updateShift: (payload) => run("updateShift", payload),
        endShift: (payload) => run("endShift", payload),
        readDashboardData: (payload) => run("readDashboardData", payload),
        addRecord: (payload) => run("addRecord", payload),
        deleteRecord: (payload) => run("deleteRecord", payload),
        getReportState: () => run("getReportState"),
        saveReportState: (payload) => run("saveReportState", payload),
        writeAction: (type, payload) => runWithArgs("writeAction", [type, payload])
      };
    })();

    const UI = (() => {
      const showToast = (type, message) => {
        const container = document.getElementById("toastContainer");
        if (!container) return;
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 4000);
      };

      const setLoader = (visible, message) => {
        const loader = document.getElementById("loader");
        const text = document.getElementById("loaderText");
        if (!loader || !text) return;
        text.textContent = message || "Salvando...";
        loader.classList.toggle("hidden", !visible);
      };

      const toggleModal = (id, show) => {
        const modal = document.getElementById(id);
        if (!modal) return;
        modal.classList.toggle("active", show);
        if (show) {
          const focusable = modal.querySelector("input, select, textarea");
          if (focusable) {
            setTimeout(() => focusable.focus(), 120);
          }
        }
      };

      const setButtonLoading = (button, loading, loadingText) => {
        if (!button) return;
        if (!button.dataset.defaultLabel) {
          button.dataset.defaultLabel = button.textContent;
        }
        button.disabled = loading;
        button.classList.toggle("is-loading", loading);
        button.textContent = loading ? (loadingText || button.dataset.defaultLabel) : button.dataset.defaultLabel;
      };

      const renderTable = (wrapperId, table, options) => {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper) return;
        wrapper.innerHTML = "";

        if (!table || !table.headers || table.headers.length === 0) {
          wrapper.innerHTML = '<p class="muted">Nenhum dado cadastrado.</p>';
          return;
        }

        const showDelete = options && options.showDelete;
        const onDelete = options && options.onDelete;

        const tableEl = document.createElement("table");
        const thead = document.createElement("thead");
        const trh = document.createElement("tr");

        table.headers.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          trh.appendChild(th);
        });

        if (showDelete) {
          const th = document.createElement("th");
          th.textContent = "Ações";
          trh.appendChild(th);
        }

        thead.appendChild(trh);
        tableEl.appendChild(thead);

        const tbody = document.createElement("tbody");
        (table.rows || []).forEach((row) => {
          const tr = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell === null || cell === undefined ? "" : cell;
            tr.appendChild(td);
          });

          if (showDelete) {
            const td = document.createElement("td");
            const btn = document.createElement("button");
            btn.className = "btn btn-ghost";
            btn.textContent = "Excluir";
            btn.addEventListener("click", () => onDelete(row[0]));
            td.appendChild(btn);
            tr.appendChild(td);
          }

          tbody.appendChild(tr);
        });

        tableEl.appendChild(tbody);
        wrapper.appendChild(tableEl);
      };

      return {
        showToast,
        setLoader,
        toggleModal,
        setButtonLoading,
        renderTable
      };
    })();

    const ReportState = (() => {
      const PALETTE_COLORS = [
        "#0E7490",
        "#1D4ED8",
        "#4338CA",
        "#7C3AED",
        "#C026D3",
        "#DB2777",
        "#DC2626",
        "#EA580C",
        "#F59E0B",
        "#16A34A",
        "#059669",
        "#0F766E",
        "#0284C7",
        "#7C2D12",
        "#4C1D95",
        "#1F2937"
      ];
      let paletteSeed = 0;
      let colorPickerListenerAttached = false;
      const editingIds = new Set();
      const FORMAT_LIMITS = { min: 12, max: 20 };
      const FORMAT_DEFAULTS = {
        line: { fontSize: 14, bold: false },
        subline: { fontSize: 13, bold: false }
      };
      const state = {
        data: { enfermagem: [], medica: [] },
        loaded: false,
        saving: false,
        pendingSave: false,
        saveTimer: null
      };

      const generateId = () => `L${Date.now().toString(36)}${Math.random().toString(36).slice(2, 8)}`;

      const normalizeFormat = (format, type) => {
        const base = FORMAT_DEFAULTS[type] || FORMAT_DEFAULTS.line;
        const payload = format && typeof format === "object" ? format : {};
        const fontSize = Number(payload.fontSize);
        return {
          fontSize: Math.min(
            FORMAT_LIMITS.max,
            Math.max(FORMAT_LIMITS.min, Number.isFinite(fontSize) ? fontSize : base.fontSize)
          ),
          bold: payload.bold === true
        };
      };

      const normalizeSublines = (sublines, depth = 0) => (sublines || [])
        .filter((sub) => sub && typeof sub === "object")
        .map((sub) => ({
          id: sub.id ? String(sub.id) : generateId(),
          text: sub.text ? String(sub.text) : "",
          locked: Boolean(sub.locked),
          format: normalizeFormat(sub.format, "subline"),
          sublines: depth >= 1 ? [] : normalizeSublines(sub.sublines, depth + 1)
        }));

      const normalizeLines = (lines) => {
        const normalized = (lines || []).map((line, index) => ({
          id: line && line.id ? String(line.id) : generateId(),
          text: line && line.text ? String(line.text) : "",
          locked: Boolean(line && line.locked),
          order: line && typeof line.order === "number" ? line.order : index,
          color: line && line.color ? String(line.color) : "",
          format: normalizeFormat(line && line.format, "line"),
          sublines: normalizeSublines(line && line.sublines, 0)
        }));
        return normalized.length
          ? normalized
          : [{
            id: generateId(),
            text: "",
            locked: false,
            order: 0,
            color: "",
            format: normalizeFormat(null, "line"),
            sublines: []
          }];
      };

      const collectUsedColors = (excludeLineId) => {
        const used = new Set();
        ["enfermagem", "medica"].forEach((key) => {
          state.data[key].forEach((line) => {
            if (!line.color) return;
            if (excludeLineId && line.id === excludeLineId) return;
            used.add(line.color);
          });
        });
        return used;
      };

      const generateColor = () => {
        const hue = (paletteSeed * 137.508) % 360;
        paletteSeed += 1;
        return `hsl(${hue} 65% 42%)`;
      };

      const lockIconHtml = (locked) => (
        locked
          ? '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 10V7a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><rect x="5" y="10" width="14" height="10" rx="2.6" stroke="currentColor" stroke-width="1.6"/><path d="M12 14v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>'
          : '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 10V7a4 4 0 0 1 8 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><rect x="5" y="10" width="14" height="10" rx="2.6" stroke="currentColor" stroke-width="1.6"/><path d="M12 14v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>'
      );

      const getUniqueColor = (preferred, excludeLineId) => {
        const used = collectUsedColors(excludeLineId);
        if (preferred && !used.has(preferred)) return preferred;
        const paletteColor = PALETTE_COLORS.find((color) => !used.has(color));
        if (paletteColor) return paletteColor;
        let candidate = generateColor();
        while (used.has(candidate)) {
          candidate = generateColor();
        }
        return candidate;
      };

      const ensureUniqueColors = () => {
        ["enfermagem", "medica"].forEach((key) => {
          state.data[key].forEach((line) => {
            line.color = getUniqueColor(line.color, line.id);
          });
        });
      };

      const setData = (payload) => {
        state.data = {
          enfermagem: normalizeLines(payload && payload.enfermagem),
          medica: normalizeLines(payload && payload.medica)
        };
        ensureUniqueColors();
      };

      const scheduleSave = () => {
        if (state.saveTimer) clearTimeout(state.saveTimer);
        state.saveTimer = setTimeout(() => {
          save();
        }, 800);
      };

      const save = async () => {
        if (state.saving) {
          state.pendingSave = true;
          return;
        }
        state.saving = true;
        state.pendingSave = false;
        try {
          await Api.saveReportState(state.data);
        } catch (err) {
          console.error(err);
          UI.showToast("error", "Falha ao salvar o relatório.");
        } finally {
          state.saving = false;
          if (state.pendingSave) {
            state.pendingSave = false;
            scheduleSave();
          }
        }
      };

      const buildLockButton = (entity, label) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = `report-lock-button${entity.locked ? " is-locked" : ""}`;
        button.setAttribute("aria-label", entity.locked ? `Destravar ${label}` : `Travar ${label}`);
        button.innerHTML = lockIconHtml(entity.locked);
        button.addEventListener("click", () => {
          entity.locked = !entity.locked;
          render();
          scheduleSave();
        });
        return button;
      };

      const isEditing = (entityId) => editingIds.has(entityId);

      const toggleEditing = (entityId) => {
        if (editingIds.has(entityId)) {
          editingIds.delete(entityId);
        } else {
          editingIds.add(entityId);
        }
      };

      const applyFormatStyles = (element, format) => {
        if (!element || !format) return;
        element.style.fontSize = `${format.fontSize}px`;
        element.style.fontWeight = format.bold ? "700" : "400";
      };

      const buildEditor = (entity, type, disabled) => {
        const editor = document.createElement("div");
        editor.className = "report-editor";

        const decButton = document.createElement("button");
        decButton.type = "button";
        decButton.className = "report-editor-button";
        decButton.textContent = "A-";
        decButton.disabled = disabled;
        decButton.addEventListener("click", () => {
          entity.format.fontSize = Math.max(FORMAT_LIMITS.min, entity.format.fontSize - 1);
          render();
          scheduleSave();
        });

        const incButton = document.createElement("button");
        incButton.type = "button";
        incButton.className = "report-editor-button";
        incButton.textContent = "A+";
        incButton.disabled = disabled;
        incButton.addEventListener("click", () => {
          entity.format.fontSize = Math.min(FORMAT_LIMITS.max, entity.format.fontSize + 1);
          render();
          scheduleSave();
        });

        const boldButton = document.createElement("button");
        boldButton.type = "button";
        boldButton.className = `report-editor-button${entity.format.bold ? " active" : ""}`;
        boldButton.textContent = "B";
        boldButton.disabled = disabled;
        boldButton.addEventListener("click", () => {
          entity.format.bold = !entity.format.bold;
          render();
          scheduleSave();
        });

        editor.appendChild(decButton);
        editor.appendChild(incButton);
        editor.appendChild(boldButton);
        return editor;
      };

      const buildEditButton = (entity, label, disabled) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = `report-edit-button${isEditing(entity.id) ? " active" : ""}`;
        button.textContent = isEditing(entity.id) ? "Editando" : "Editar";
        button.setAttribute("aria-label", `Editar ${label}`);
        button.disabled = disabled;
        button.addEventListener("click", () => {
          toggleEditing(entity.id);
          render();
        });
        return button;
      };

      const renderSublines = (sublines, container, parentLocked, lineColor, depth) => {
        (sublines || []).forEach((subline, subIndex) => {
          const subRow = document.createElement("div");
          subRow.className = `report-subline${depth > 0 ? " is-nested" : ""}`;
          subRow.style.setProperty("--line-color", lineColor);

          const marker = document.createElement("span");
          marker.className = "report-subline-marker";

          const body = document.createElement("div");
          body.className = "report-subline-body";

          const inputRow = document.createElement("div");
          inputRow.className = "report-subline-input";

          const subText = document.createElement("textarea");
          subText.className = "report-subline-text";
          subText.value = subline.text;
          subText.disabled = parentLocked || subline.locked || !isEditing(subline.id);
          applyFormatStyles(subText, subline.format);
          subText.addEventListener("input", (event) => {
            subline.text = event.target.value;
            scheduleSave();
          });

          const actions = document.createElement("div");
          actions.className = "report-subline-actions";

          const lockButton = buildLockButton(subline, "sublinha");
          const editButton = buildEditButton(subline, "sublinha", parentLocked || subline.locked);
          const editor = buildEditor(subline, "subline", parentLocked || subline.locked || !isEditing(subline.id));

          const subDelete = document.createElement("button");
          subDelete.type = "button";
          subDelete.className = "report-subline-remove";
          subDelete.textContent = "×";
          subDelete.disabled = parentLocked || subline.locked;
          subDelete.addEventListener("click", () => {
            if (parentLocked || subline.locked) return;
            sublines.splice(subIndex, 1);
            render();
            scheduleSave();
          });

          actions.appendChild(lockButton);
          actions.appendChild(editButton);
          actions.appendChild(editor);
          actions.appendChild(subDelete);

          inputRow.appendChild(subText);
          inputRow.appendChild(actions);

          const childrenWrapper = document.createElement("div");
          childrenWrapper.className = "report-subline-children";
          renderSublines(
            subline.sublines || [],
            childrenWrapper,
            parentLocked || subline.locked,
            lineColor,
            depth + 1
          );

          let addSubline = null;
          if (depth < 1) {
            addSubline = document.createElement("button");
            addSubline.type = "button";
            addSubline.className = "report-add-subline is-nested";
            addSubline.innerHTML = '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>';
            addSubline.setAttribute("aria-label", "Adicionar sublinha");
            addSubline.disabled = parentLocked || subline.locked;
            addSubline.addEventListener("click", () => {
              if (parentLocked || subline.locked) return;
              if (!Array.isArray(subline.sublines)) {
                subline.sublines = [];
              }
              subline.sublines.push({
                id: generateId(),
                text: "",
                locked: false,
                format: normalizeFormat(null, "subline"),
                sublines: []
              });
              render();
              scheduleSave();
            });
          }

          body.appendChild(inputRow);
          body.appendChild(childrenWrapper);
          if (addSubline) {
            body.appendChild(addSubline);
          }

          subRow.appendChild(marker);
          subRow.appendChild(body);
          container.appendChild(subRow);
        });
      };

      const renderColumn = (key, containerId) => {
        const wrapper = document.getElementById(containerId);
        if (!wrapper) return;
        wrapper.innerHTML = "";
        state.data[key].forEach((line, index) => {
          const row = document.createElement("div");
          row.className = `report-line${line.locked ? " locked" : ""}`;
          row.style.setProperty("--line-color", line.color);

          const main = document.createElement("div");
          main.className = "report-line-main";

          const header = document.createElement("div");
          header.className = "report-line-header";

          const meta = document.createElement("div");
          meta.className = "report-line-meta";
          const metaLabel = document.createElement("span");
          metaLabel.className = "report-line-label";
          metaLabel.textContent = `Linha ${index + 1}`;

          const lockButton = buildLockButton(line, "linha");
          const editButton = buildEditButton(line, "linha", line.locked);

          meta.appendChild(metaLabel);
          meta.appendChild(lockButton);
          meta.appendChild(editButton);

          const picker = document.createElement("div");
          picker.className = "report-color-picker";

          const colorButton = document.createElement("button");
          colorButton.type = "button";
          colorButton.className = "report-color-button";
          colorButton.style.setProperty("--line-color", line.color);
          colorButton.setAttribute("aria-label", "Selecionar cor da linha");
          colorButton.addEventListener("click", (event) => {
            event.stopPropagation();
            picker.classList.toggle("open");
          });

          const palette = document.createElement("div");
          palette.className = "report-color-palette";

          const usedColors = collectUsedColors(line.id);
          const paletteColors = [...PALETTE_COLORS];
          if (!paletteColors.includes(line.color)) {
            paletteColors.unshift(line.color);
          }

          paletteColors.forEach((color) => {
            const option = document.createElement("button");
            option.type = "button";
            option.className = "report-color-option";
            option.style.background = color;
            option.disabled = usedColors.has(color);
            option.addEventListener("click", () => {
              if (usedColors.has(color)) return;
              line.color = color;
              render();
              scheduleSave();
            });
            palette.appendChild(option);
          });

          const generateButton = document.createElement("button");
          generateButton.type = "button";
          generateButton.className = "report-color-generate";
          generateButton.textContent = "Nova cor";
          generateButton.addEventListener("click", () => {
            line.color = getUniqueColor("", line.id);
            render();
            scheduleSave();
          });
          palette.appendChild(generateButton);

          picker.appendChild(colorButton);
          picker.appendChild(palette);

          header.appendChild(picker);
          header.appendChild(meta);

          const textarea = document.createElement("textarea");
          textarea.className = "report-text";
          textarea.value = line.text;
          textarea.disabled = line.locked || !isEditing(line.id);
          applyFormatStyles(textarea, line.format);
          textarea.addEventListener("input", (event) => {
            line.text = event.target.value;
            scheduleSave();
          });

          const editor = buildEditor(line, "line", line.locked || !isEditing(line.id));

          const sublinesWrapper = document.createElement("div");
          sublinesWrapper.className = "report-sublines";
          renderSublines(line.sublines || [], sublinesWrapper, line.locked, line.color, 0);

          const addSubline = document.createElement("button");
          addSubline.type = "button";
          addSubline.className = "report-add-subline";
          addSubline.innerHTML = '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>';
          addSubline.setAttribute("aria-label", "Adicionar sublinha");
          addSubline.disabled = line.locked;
          addSubline.addEventListener("click", () => {
            if (line.locked) return;
            line.sublines.push({
              id: generateId(),
              text: "",
              locked: false,
              format: normalizeFormat(null, "subline"),
              sublines: []
            });
            render();
            scheduleSave();
          });

          main.appendChild(header);
          main.appendChild(editor);
          main.appendChild(textarea);
          main.appendChild(sublinesWrapper);
          main.appendChild(addSubline);

          const actions = document.createElement("div");
          actions.className = "report-actions";

          const btnUp = document.createElement("button");
          btnUp.className = "report-action";
          btnUp.textContent = "Subir";
          btnUp.disabled = index === 0;
          btnUp.addEventListener("click", () => {
            const list = state.data[key];
            [list[index - 1], list[index]] = [list[index], list[index - 1]];
            render();
            scheduleSave();
          });

          const btnDown = document.createElement("button");
          btnDown.className = "report-action";
          btnDown.textContent = "Descer";
          btnDown.disabled = index === state.data[key].length - 1;
          btnDown.addEventListener("click", () => {
            const list = state.data[key];
            [list[index + 1], list[index]] = [list[index], list[index + 1]];
            render();
            scheduleSave();
          });

          const btnDelete = document.createElement("button");
          btnDelete.className = "report-action";
          btnDelete.textContent = "Excluir";
          btnDelete.disabled = line.locked;
          btnDelete.addEventListener("click", () => {
            if (line.locked) return;
            state.data[key].splice(index, 1);
            if (state.data[key].length === 0) {
              state.data[key].push({
                id: generateId(),
                text: "",
                locked: false,
                order: 0,
                color: getUniqueColor(""),
                sublines: []
              });
            }
            render();
            scheduleSave();
          });

          actions.appendChild(btnUp);
          actions.appendChild(btnDown);
          actions.appendChild(btnDelete);

          row.appendChild(main);
          row.appendChild(actions);
          wrapper.appendChild(row);
        });
      };

      const render = () => {
        ensureUniqueColors();
        renderColumn("enfermagem", "reportEnfermagem");
        renderColumn("medica", "reportMedica");
        if (!colorPickerListenerAttached) {
          document.addEventListener("click", () => {
            document.querySelectorAll(".report-color-picker.open").forEach((picker) => {
              picker.classList.remove("open");
            });
          });
          colorPickerListenerAttached = true;
        }
      };

      const addLine = (key) => {
        state.data[key].push({
          id: generateId(),
          text: "",
          locked: false,
          order: state.data[key].length,
          color: getUniqueColor(""),
          format: normalizeFormat(null, "line"),
          sublines: []
        });
        render();
        scheduleSave();
      };

      return {
        ensureLoaded: async () => {
          if (state.loaded) return;
          try {
            const payload = await Api.getReportState();
            setData(payload);
            render();
            state.loaded = true;
          } catch (err) {
            console.error(err);
            UI.showToast("error", "Falha ao carregar o relatório.");
          }
        },
        addLine,
        render
      };
    })();

    const AppState = (() => {
      const state = {
        view: "confirmadas",
        page: "ocorrencias",
        app: null,
        dashboard: null,
        dashboardByView: {},
        activeShift: null,
        isSaving: false
      };

      const viewMap = {
        confirmadas: {
          sheet: "RESERVA_CONFIRMADA",
          title: "Reservas confirmadas",
          subtitle: "Pacientes com reserva confirmada para UIB"
        },
        vascular: {
          sheet: "PROCEDIMENTO_VASCULAR",
          title: "Procedimentos vasculares",
          subtitle: "Reservas vinculadas a procedimentos vasculares"
        },
        negadas: {
          sheet: "RESERVA_NEGADA",
          title: "Reservas negadas",
          subtitle: "Reservas canceladas/negadas no plantão"
        },
        anterior: {
          sheet: "PLANTAO_ANTERIOR",
          title: "Plantão anterior",
          subtitle: "Pacientes admitidos na UIB no plantão anterior"
        }
      };

      const moduleConfig = {
        RESERVA_CONFIRMADA: {
          title: "Nova reserva confirmada",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "leito", label: "Leito reservado", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "status", label: "Status", type: "text" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataConfirmacao", label: "Data da confirmação", type: "date" },
            { name: "horaConfirmacao", label: "Hora da confirmação", type: "time" },
            { name: "chegou", label: "Chegou (SIM/NÃO)", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "leito",
            "especialidade",
            "origem",
            "status",
            "dataReserva",
            "horaReserva",
            "dataConfirmacao",
            "horaConfirmacao",
            "tempoAceite",
            "chegou",
            "observacao"
          ]
        },
        PROCEDIMENTO_VASCULAR: {
          title: "Novo procedimento vascular",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "leito", label: "Leito reservado", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "status", label: "Status", type: "text" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataConfirmacao", label: "Data da confirmação", type: "date" },
            { name: "horaConfirmacao", label: "Hora da confirmação", type: "time" },
            { name: "chegou", label: "Chegou (SIM/NÃO)", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "leito",
            "especialidade",
            "origem",
            "status",
            "dataReserva",
            "horaReserva",
            "dataConfirmacao",
            "horaConfirmacao",
            "tempoAceite",
            "chegou",
            "observacao"
          ]
        },
        RESERVA_NEGADA: {
          title: "Nova reserva negada",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "justificativa", label: "Justificativa", type: "textarea" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataCancelamento", label: "Data do cancelamento", type: "date" },
            { name: "horaCancelamento", label: "Hora do cancelamento", type: "time" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "origem",
            "especialidade",
            "justificativa",
            "dataReserva",
            "horaReserva",
            "dataCancelamento",
            "horaCancelamento",
            "tempoCancelamento"
          ]
        },
        PLANTAO_ANTERIOR: {
          title: "Adicionar paciente do plantão anterior",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "leito", label: "Leito reservado", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "status", label: "Status", type: "text" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataAdmissao", label: "Data de admissão", type: "date" },
            { name: "horaAdmissao", label: "Hora de admissão", type: "time" },
            { name: "chegou", label: "Chegou (SIM/NÃO)", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "leito",
            "especialidade",
            "origem",
            "status",
            "dataReserva",
            "horaReserva",
            "dataAdmissao",
            "horaAdmissao",
            "tempoDecorrido",
            "chegou",
            "observacao"
          ]
        },
        BLOQUEADOS_MANUTENCAO: {
          title: "Novo bloqueio de manutenção",
          fields: [
            { name: "leito", label: "Leito", type: "text" },
            { name: "unidade", label: "Unidade", type: "text" },
            { name: "manutencaoAcionada", label: "Manutenção acionada", type: "text" },
            { name: "dataInicio", label: "Data de início", type: "date" },
            { name: "previsaoReparo", label: "Previsão de reparo", type: "date" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "leito",
            "unidade",
            "manutencaoAcionada",
            "dataInicio",
            "previsaoReparo",
            "observacao"
          ]
        },
        BLOQUEADOS_ISOLAMENTO: {
          title: "Novo bloqueio por isolamento",
          fields: [
            { name: "unidade", label: "Unidade", type: "text" },
            { name: "leito", label: "Leito", type: "text" },
            { name: "paciente", label: "Paciente", type: "text" },
            { name: "tipoIsolamento", label: "Tipo de isolamento", type: "text" },
            { name: "patologia", label: "Patologia", type: "text" },
            { name: "inicioIsolamento", label: "Início do isolamento", type: "date" },
            { name: "tempoPrevisto", label: "Tempo previsto", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "unidade",
            "leito",
            "paciente",
            "tipoIsolamento",
            "patologia",
            "inicioIsolamento",
            "tempoPrevisto",
            "observacao"
          ]
        }
      };

      const formatDate = (value) => {
        if (!value) return "-";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        return dt.toLocaleDateString("pt-BR");
      };

      const dayNames = [
        "Domingo",
        "Segunda-feira",
        "Terça-feira",
        "Quarta-feira",
        "Quinta-feira",
        "Sexta-feira",
        "Sábado"
      ];

      const getDayOfWeekFromDate = (value) => {
        if (!value) return "";
        const parts = value.split("-").map(Number);
        if (parts.length !== 3) return "";
        const date = new Date(parts[0], parts[1] - 1, parts[2]);
        if (Number.isNaN(date.getTime())) return "";
        return dayNames[date.getDay()] || "";
      };

      const normalizeTurno = (value) => {
        const turno = String(value || "").trim().toUpperCase();
        return turno === "MT" || turno === "SN" ? turno : "";
      };

      const setShiftSummary = (shift) => {
        const badge = document.getElementById("statusBadge");
        const summary = document.getElementById("shiftSummary");
        const active = Boolean(shift && shift.id);

        badge.textContent = active ? `Plantão ativo ${shift.id}` : "Sem plantão ativo";
        badge.style.background = active ? "rgba(36, 138, 61, 0.12)" : "rgba(215, 0, 21, 0.12)";
        badge.style.color = active ? "var(--success)" : "var(--danger)";

        summary.textContent = active
          ? `Plantão ${shift.id} • ${shift.dayOfWeek || "Dia não informado"} • ${shift.shift || "Turno não informado"} • ${formatDate(shift.date)}`
          : "Nenhum plantão ativo.";

        const info = {
          infoData: formatDate(shift && shift.date),
          infoDia: shift && shift.dayOfWeek ? shift.dayOfWeek : "-",
          infoTurno: shift && shift.shift ? shift.shift : "-",
          infoMed1: shift && shift.team ? shift.team.medico1 : "-",
          infoMed2: shift && shift.team ? shift.team.medico2 : "-",
          infoEnf1: shift && shift.team ? shift.team.enf1 : "-",
          infoEnf2: shift && shift.team ? shift.team.enf2 : "-",
          infoAux: shift && shift.team ? shift.team.aux : "-"
        };

        Object.keys(info).forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.textContent = info[id] || "-";
        });
      };

      const setIndicators = (ind) => {
        if (!ind) return;
        document.getElementById("kpiAlocados").textContent = ind.alocados || 0;
        document.getElementById("kpiConfirmadas").textContent = ind.reservasConfirmadas || 0;
        document.getElementById("kpiCanceladas").textContent = ind.reservasCanceladas || 0;
        document.getElementById("kpiAdmitidos").textContent = ind.admitidosUIB || 0;
      };

      const renderDashboard = () => {
        const dashboard = state.dashboard;
        if (!dashboard) return;

        const viewConfig = viewMap[state.view];
        document.getElementById("principalTitle").textContent = viewConfig.title;
        document.getElementById("principalSubtitle").textContent = viewConfig.subtitle;

        UI.renderTable("principalTable", dashboard.principal, {
          showDelete: true,
          onDelete: (id) => handleDelete(viewConfig.sheet, id, "principal")
        });
        UI.renderTable("manutencaoTable", dashboard.manutencao, {
          showDelete: true,
          onDelete: (id) => handleDelete("BLOQUEADOS_MANUTENCAO", id, "manutencao")
        });
        UI.renderTable("isolamentoTable", dashboard.isolamento, {
          showDelete: true,
          onDelete: (id) => handleDelete("BLOQUEADOS_ISOLAMENTO", id, "isolamento")
        });
      };

      const setTabs = () => {
        document.querySelectorAll(".tab").forEach((tab) => {
          const view = tab.getAttribute("data-view");
          tab.classList.toggle("active", view === state.view);
        });
      };

      const setPage = (page) => {
        state.page = page;
        const isRelatorio = page === "relatorio";
        document.getElementById("ocorrenciasPage").classList.toggle("hidden", isRelatorio);
        document.getElementById("relatorioPage").classList.toggle("hidden", !isRelatorio);
        document.getElementById("menuLabel").textContent = isRelatorio ? "Relatório" : "Ocorrências";
        document.querySelectorAll(".menu-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.page === page);
        });
        document.getElementById("pageTitle").textContent = isRelatorio
          ? "Relatório das Ocorrências do Plantão"
          : "Ocorrências do Plantão";
        document.getElementById("pageSubtitle").textContent = isRelatorio
          ? "Painel contínuo com travamento por linha."
          : "Núcleo Interno de Regulação (NIR)";
        if (isRelatorio) {
          ReportState.ensureLoaded();
        }
      };

      const showCachedDashboard = (view) => {
        const cached = state.dashboardByView[view];
        if (!cached) return false;
        state.dashboard = cached;
        state.activeShift = cached.activeShift || state.activeShift;
        setShiftSummary(state.activeShift);
        setIndicators(cached.indicadores);
        renderDashboard();
        return true;
      };

      const loadDashboard = async (view, options) => {
        const config = options || {};
        const showLoader = config.showLoader !== false;
        const updateUI = config.updateUI !== false;

        if (showLoader) {
          UI.setLoader(true, "Carregando...");
        }
        try {
          const dashboard = await Api.readDashboardData({ view: view });
          state.dashboardByView[view] = dashboard;

          if (updateUI && view === state.view) {
            state.dashboard = dashboard;
            state.activeShift = dashboard.activeShift || state.activeShift;
            setShiftSummary(state.activeShift);
            setIndicators(dashboard.indicadores);
            renderDashboard();
            setTabs();
          }
        } catch (err) {
          console.error(err);
          UI.showToast("error", "Falha ao carregar o painel.");
        } finally {
          if (showLoader) {
            UI.setLoader(false);
          }
        }
      };

      const handleSaveShift = async () => {
        const dataValue = document.getElementById("shiftData").value;
        const saveButton = document.getElementById("btnSaveShift");
        const payload = {
          data: dataValue,
          diaSemana: getDayOfWeekFromDate(dataValue),
          turno: normalizeTurno(document.getElementById("shiftTurno").value),
          medico1: document.getElementById("shiftMed1").value,
          medico2: document.getElementById("shiftMed2").value,
          enf1: document.getElementById("shiftEnf1").value,
          enf2: document.getElementById("shiftEnf2").value,
          aux: document.getElementById("shiftAux").value
        };

        const previous = state.activeShift;
        const optimistic = {
          id: previous && previous.id ? previous.id : "SALVANDO",
          date: payload.data,
          dayOfWeek: payload.diaSemana,
          shift: payload.turno,
          team: {
            medico1: payload.medico1,
            medico2: payload.medico2,
            enf1: payload.enf1,
            enf2: payload.enf2,
            aux: payload.aux
          },
          startedAt: previous && previous.startedAt ? previous.startedAt : new Date().toISOString()
        };

        state.activeShift = optimistic;
        setShiftSummary(state.activeShift);
        UI.setButtonLoading(saveButton, true, "Salvando...");
        UI.setLoader(true, previous ? "Atualizando plantão..." : "Abrindo plantão...");

        try {
          const response = previous
            ? await Api.updateShift(payload)
            : await Api.startShift(payload);

          state.activeShift = response.activeShift;
          setShiftSummary(state.activeShift);
          UI.toggleModal("modalShift", false);
          UI.showToast("success", "Plantão salvo com sucesso.");
          await loadDashboard(state.view, { showLoader: false });
        } catch (err) {
          console.error(err);
          state.activeShift = previous;
          setShiftSummary(state.activeShift);
          UI.showToast("error", err.message || "Erro ao salvar plantão.");
        } finally {
          UI.setLoader(false);
          UI.setButtonLoading(saveButton, false);
        }
      };

      const handleEndShift = async () => {
        if (!state.activeShift || !state.activeShift.id) {
          UI.showToast("info", "Nenhum plantão ativo.");
          return;
        }

        if (!confirm("Encerrar o plantão atual?")) return;

        const previous = state.activeShift;
        state.activeShift = null;
        setShiftSummary(state.activeShift);
        UI.setLoader(true, "Encerrando plantão...");

        try {
          await Api.endShift(previous.id);
          UI.showToast("success", "Plantão encerrado.");
          await loadDashboard(state.view, { showLoader: false });
        } catch (err) {
          console.error(err);
          state.activeShift = previous;
          setShiftSummary(state.activeShift);
          UI.showToast("error", err.message || "Erro ao encerrar plantão.");
        } finally {
          UI.setLoader(false);
        }
      };

      const handleDelete = async (moduleName, id, tableKey) => {
        if (!id) {
          UI.showToast("info", "Registro sem ID.");
          return;
        }
        if (!confirm("Excluir esse registro?")) return;

        const previous = JSON.parse(JSON.stringify(state.dashboard[tableKey]));
        state.dashboard[tableKey].rows = state.dashboard[tableKey].rows.filter((row) => String(row[0]) !== String(id));
        renderDashboard();
        UI.setLoader(true, "Excluindo registro...");

        try {
          await Api.deleteRecord({ modulo: moduleName, id: String(id) });
          UI.showToast("success", "Registro excluído.");
          await loadDashboard(state.view, { showLoader: false });
        } catch (err) {
          console.error(err);
          state.dashboard[tableKey] = previous;
          renderDashboard();
          UI.showToast("error", err.message || "Erro ao excluir.");
        } finally {
          UI.setLoader(false);
        }
      };

      const handleAddRecord = (moduleName) => {
        const config = moduleConfig[moduleName];
        if (!config) return;
        const body = document.getElementById("recordFields");
        body.innerHTML = "";
        document.getElementById("recordTitle").textContent = config.title;

        const section = document.createElement("section");
        section.className = "modal-section";
        const title = document.createElement("div");
        title.className = "modal-section-title";
        title.textContent = "Detalhes do registro";
        const grid = document.createElement("div");
        grid.className = "form-grid";

        config.fields.forEach((field) => {
          const wrapper = document.createElement("label");
          wrapper.className = field.type === "textarea" ? "field field-textarea" : "field";
          const span = document.createElement("span");
          span.textContent = field.label;
          const input = field.type === "textarea" ? document.createElement("textarea") : document.createElement("input");
          input.className = field.type === "textarea" ? "textarea" : "input";
          input.type = field.type === "textarea" ? "text" : field.type;
          input.dataset.name = field.name;
          wrapper.appendChild(span);
          wrapper.appendChild(input);
          grid.appendChild(wrapper);
        });

        section.appendChild(title);
        section.appendChild(grid);
        body.appendChild(section);
        body.dataset.module = moduleName;
        UI.toggleModal("modalRecord", true);
      };

      const handleSaveRecord = async () => {
        const body = document.getElementById("recordFields");
        const moduleName = body.dataset.module;
        const config = moduleConfig[moduleName];
        if (!config) return;
        const saveButton = document.getElementById("btnSaveRecord");

        const record = {};
        body.querySelectorAll("[data-name]").forEach((input) => {
          record[input.dataset.name] = input.value || "";
        });

        const optimisticRow = config.rowOrder.map((key) => {
          if (key === "id") return "SALVANDO";
          return record[key] || "";
        });

        const tableKey = moduleName === viewMap[state.view].sheet ? "principal" : moduleName === "BLOQUEADOS_MANUTENCAO" ? "manutencao" : "isolamento";
        state.dashboard[tableKey].rows.unshift(optimisticRow);
        renderDashboard();
        UI.setButtonLoading(saveButton, true, "Salvando...");
        UI.setLoader(true, "Salvando registro...");

        try {
          await Api.addRecord({ modulo: moduleName, registro: record });
          UI.toggleModal("modalRecord", false);
          UI.showToast("success", "Registro salvo.");
          await loadDashboard(state.view, { showLoader: false });
        } catch (err) {
          console.error(err);
          state.dashboard[tableKey].rows = state.dashboard[tableKey].rows.filter((row) => row[0] !== "SALVANDO");
          renderDashboard();
          UI.showToast("error", err.message || "Erro ao salvar registro.");
        } finally {
          UI.setLoader(false);
          UI.setButtonLoading(saveButton, false);
        }
      };

      const openShiftModal = () => {
        const shift = state.activeShift;
        document.getElementById("shiftData").value = shift && shift.date ? shift.date : "";
        document.getElementById("shiftTurno").value = normalizeTurno(shift && shift.shift ? shift.shift : "");
        document.getElementById("shiftMed1").value = shift && shift.team ? shift.team.medico1 : "";
        document.getElementById("shiftMed2").value = shift && shift.team ? shift.team.medico2 : "";
        document.getElementById("shiftEnf1").value = shift && shift.team ? shift.team.enf1 : "";
        document.getElementById("shiftEnf2").value = shift && shift.team ? shift.team.enf2 : "";
        document.getElementById("shiftAux").value = shift && shift.team ? shift.team.aux : "";
        UI.toggleModal("modalShift", true);
      };

      const initEvents = () => {
        const menuToggle = document.getElementById("menuToggle");
        const menuDropdown = document.getElementById("menuDropdown");
        menuToggle.addEventListener("click", () => {
          menuDropdown.classList.toggle("hidden");
        });
        document.addEventListener("click", (event) => {
          if (!menuDropdown.contains(event.target) && !menuToggle.contains(event.target)) {
            menuDropdown.classList.add("hidden");
          }
        });
        document.querySelectorAll(".menu-item").forEach((item) => {
          item.addEventListener("click", () => {
            menuDropdown.classList.add("hidden");
            setPage(item.dataset.page);
          });
        });

        document.querySelectorAll("[data-action='add-line']").forEach((btn) => {
          btn.addEventListener("click", () => {
            ReportState.addLine(btn.dataset.column);
          });
        });

        document.getElementById("btnRefresh").addEventListener("click", () => loadDashboard(state.view, { showLoader: false }));
        document.getElementById("btnStartShift").addEventListener("click", openShiftModal);
        document.getElementById("btnEditShift").addEventListener("click", openShiftModal);
        document.getElementById("btnEndShift").addEventListener("click", handleEndShift);
        document.getElementById("btnSaveShift").addEventListener("click", handleSaveShift);
        document.getElementById("btnSaveRecord").addEventListener("click", handleSaveRecord);
        document.getElementById("btnAddPrincipal").addEventListener("click", () => handleAddRecord(viewMap[state.view].sheet));
        document.getElementById("btnAddManutencao").addEventListener("click", () => handleAddRecord("BLOQUEADOS_MANUTENCAO"));
        document.getElementById("btnAddIsolamento").addEventListener("click", () => handleAddRecord("BLOQUEADOS_ISOLAMENTO"));

        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            state.view = tab.dataset.view;
            setTabs();
            const hasCache = showCachedDashboard(state.view);
            loadDashboard(state.view, { showLoader: !hasCache });
          });
        });

        document.querySelectorAll("[data-close]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-close");
            UI.toggleModal(target, false);
          });
        });
      };

      return {
        init: () => {
          initEvents();
          setPage(state.page);
          loadDashboard(state.view, { showLoader: true })
            .then(() => {
              Object.keys(viewMap).forEach((view) => {
                if (view === state.view) return;
                if (state.dashboardByView[view]) return;
                loadDashboard(view, { showLoader: false, updateUI: false });
              });
            });
        }
      };
    })();

    document.addEventListener("DOMContentLoaded", () => {
      AppState.init();
    });
  </script>
</body>
</html>
