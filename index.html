<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ocorrências do Plantão – NIR</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f5f5f7;
      --surface: #ffffff;
      --surface-alt: #f9fafb;
      --border: #e5e5ea;
      --text: #1d1d1f;
      --text-muted: #6e6e73;
      --accent: #007aff;
      --accent-strong: #0056d6;
      --danger: #d70015;
      --success: #248a3d;
      --shadow: 0 16px 30px rgba(0, 0, 0, 0.08);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --spacing-xs: 6px;
      --spacing-sm: 10px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", system-ui, sans-serif;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1013;
        --surface: #1a1c20;
        --surface-alt: #202329;
        --border: #2c2f36;
        --text: #f5f5f7;
        --text-muted: #b0b3b8;
        --accent: #0a84ff;
        --accent-strong: #409cff;
        --danger: #ff453a;
        --success: #30d158;
        --shadow: 0 16px 30px rgba(0, 0, 0, 0.35);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: var(--spacing-lg) var(--spacing-xl);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .title-stack h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }

    .subtitle {
      margin: 0;
      color: var(--text-muted);
    }

    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0, 122, 255, 0.12);
      color: var(--accent-strong);
      font-weight: 600;
      border: 1px solid rgba(0, 122, 255, 0.2);
    }

    .app-content {
      padding: var(--spacing-xl);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .grid {
      display: grid;
      gap: var(--spacing-lg);
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .card-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .card-content {
      padding: var(--spacing-lg);
    }

    .muted {
      color: var(--text-muted);
      margin: 4px 0 0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--spacing-md);
    }

    .info-item {
      background: var(--surface-alt);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .info-item span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--spacing-md);
    }

    .kpi {
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .kpi strong {
      font-size: 20px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: var(--surface-alt);
      color: var(--text);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }

    .btn:focus-visible {
      outline: 3px solid rgba(0, 122, 255, 0.35);
      outline-offset: 2px;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-secondary {
      background: rgba(0, 0, 0, 0.04);
    }

    .btn-danger {
      background: rgba(215, 0, 21, 0.12);
      color: var(--danger);
      border-color: rgba(215, 0, 21, 0.2);
    }

    .btn-ghost {
      background: transparent;
      border-color: var(--border);
    }

    .btn-lg {
      padding: 12px 20px;
      font-size: 15px;
    }

    .tabs {
      display: flex;
      gap: 6px;
      background: var(--surface-alt);
      border-radius: 999px;
      padding: 4px;
    }

    .tab {
      border: none;
      background: transparent;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 600;
    }

    .tab.active {
      background: var(--accent);
      color: #fff;
    }

    .table-wrapper {
      padding: var(--spacing-md);
      overflow: auto;
    }

    .table-wrapper table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .table-wrapper th,
    .table-wrapper td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
    }

    .table-wrapper tr:hover {
      background: rgba(0, 122, 255, 0.06);
    }

    .table-action {
      display: inline-flex;
      gap: 6px;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface-alt);
      color: var(--text);
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      outline: 3px solid rgba(0, 122, 255, 0.3);
      border-color: var(--accent);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 15, 20, 0.4);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease;
      z-index: 20;
      padding: var(--spacing-lg);
    }

    .modal-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      max-width: 760px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }

    .modal-header,
    .modal-footer {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
    }

    .modal-footer {
      border-top: 1px solid var(--border);
      border-bottom: none;
    }

    .modal-body {
      padding: var(--spacing-lg);
      overflow: auto;
    }

    .toast-container {
      position: fixed;
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 30;
    }

    .toast {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      font-weight: 600;
    }

    .toast.success {
      border-color: rgba(36, 138, 61, 0.4);
      color: var(--success);
    }

    .toast.error {
      border-color: rgba(215, 0, 21, 0.4);
      color: var(--danger);
    }

    .toast.info {
      border-color: rgba(0, 122, 255, 0.4);
      color: var(--accent);
    }

    .loader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: #fff;
      font-weight: 600;
      z-index: 40;
    }

    .loader.hidden {
      display: none;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(255, 255, 255, 0.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .skeleton {
      animation: pulse 1.5s ease-in-out infinite;
      background: linear-gradient(90deg, rgba(200, 200, 200, 0.2), rgba(200, 200, 200, 0.4), rgba(200, 200, 200, 0.2));
      border-radius: var(--radius-md);
      height: 14px;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .app-header {
        padding: var(--spacing-md);
      }

      .app-content {
        padding: var(--spacing-md);
      }

      .tabs {
        flex-wrap: wrap;
      }

      .header-actions {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="app-header">
      <div class="header-title">
        <div class="title-stack">
          <h1>Ocorrências do Plantão</h1>
          <p class="subtitle">Núcleo Interno de Regulação (NIR)</p>
        </div>
        <span id="statusBadge" class="badge">Sem plantão ativo</span>
      </div>
      <div class="header-actions">
        <button id="btnRefresh" class="btn btn-ghost btn-lg">Atualizar</button>
        <button id="btnStartShift" class="btn btn-primary btn-lg">Iniciar plantão</button>
        <button id="btnEndShift" class="btn btn-danger btn-lg">Encerrar plantão</button>
      </div>
    </header>

    <main class="app-content">
      <section class="grid grid-2">
        <article class="card">
          <header class="card-header">
            <div>
              <h2>Plantão ativo</h2>
              <p class="muted" id="shiftSummary">Nenhum plantão ativo.</p>
            </div>
            <button id="btnEditShift" class="btn btn-secondary">Equipe do plantão</button>
          </header>
          <div class="card-content">
            <div class="info-grid">
              <div class="info-item"><span>Data</span><strong id="infoData">-</strong></div>
              <div class="info-item"><span>Dia</span><strong id="infoDia">-</strong></div>
              <div class="info-item"><span>Turno</span><strong id="infoTurno">-</strong></div>
              <div class="info-item"><span>Médico(a) 1</span><strong id="infoMed1">-</strong></div>
              <div class="info-item"><span>Médico(a) 2</span><strong id="infoMed2">-</strong></div>
              <div class="info-item"><span>Enfermeiro(a) 1</span><strong id="infoEnf1">-</strong></div>
              <div class="info-item"><span>Enfermeiro(a) 2</span><strong id="infoEnf2">-</strong></div>
              <div class="info-item"><span>Auxiliar</span><strong id="infoAux">-</strong></div>
            </div>
          </div>
        </article>

        <article class="card">
          <header class="card-header">
            <div>
              <h2>Indicadores do plantão</h2>
              <p class="muted">Atualizados automaticamente</p>
            </div>
          </header>
          <div class="card-content">
            <div class="kpi-grid">
              <div class="kpi">
                <span>Alocados</span>
                <strong id="kpiAlocados">0</strong>
              </div>
              <div class="kpi">
                <span>Reservas confirmadas</span>
                <strong id="kpiConfirmadas">0</strong>
              </div>
              <div class="kpi">
                <span>Reservas canceladas</span>
                <strong id="kpiCanceladas">0</strong>
              </div>
              <div class="kpi">
                <span>Admitidos UIB</span>
                <strong id="kpiAdmitidos">0</strong>
              </div>
            </div>
          </div>
        </article>
      </section>

      <section class="card">
        <header class="card-header">
          <div>
            <h2 id="principalTitle">Reservas confirmadas</h2>
            <p class="muted" id="principalSubtitle">Pacientes com reserva confirmada para UIB</p>
          </div>
          <div class="header-actions">
            <div class="tabs">
              <button class="tab active" data-view="confirmadas">Confirmadas</button>
              <button class="tab" data-view="vascular">Vascular</button>
              <button class="tab" data-view="negadas">Negadas</button>
              <button class="tab" data-view="anterior">Plantão anterior</button>
            </div>
            <button id="btnAddPrincipal" class="btn btn-primary">Adicionar registro</button>
          </div>
        </header>
        <div id="principalTable" class="table-wrapper"></div>
      </section>

      <section class="grid grid-2">
        <article class="card">
          <header class="card-header">
            <div>
              <h2>Bloqueios de manutenção</h2>
              <p class="muted">Leitos temporariamente indisponíveis</p>
            </div>
            <button id="btnAddManutencao" class="btn btn-secondary">Adicionar</button>
          </header>
          <div id="manutencaoTable" class="table-wrapper"></div>
        </article>

        <article class="card">
          <header class="card-header">
            <div>
              <h2>Bloqueios de isolamento</h2>
              <p class="muted">Leitos reservados por isolamento</p>
            </div>
            <button id="btnAddIsolamento" class="btn btn-secondary">Adicionar</button>
          </header>
          <div id="isolamentoTable" class="table-wrapper"></div>
        </article>
      </section>
    </main>
  </div>

  <div id="modalShift" class="modal-backdrop">
    <div class="modal">
      <header class="modal-header">
        <h3>Equipe do plantão</h3>
        <button class="btn btn-ghost" data-close="modalShift">Fechar</button>
      </header>
      <div class="modal-body">
        <div class="form-grid">
          <label class="field">
            <span>Data do plantão</span>
            <input class="input" type="date" id="shiftData">
          </label>
          <label class="field">
            <span>Dia da semana</span>
            <input class="input" type="text" id="shiftDia" placeholder="Ex: Segunda-feira">
          </label>
          <label class="field">
            <span>Turno</span>
            <input class="input" type="text" id="shiftTurno" placeholder="Ex: 07:00 - 19:00">
          </label>
          <label class="field">
            <span>Médico(a) 1</span>
            <input class="input" type="text" id="shiftMed1">
          </label>
          <label class="field">
            <span>Médico(a) 2</span>
            <input class="input" type="text" id="shiftMed2">
          </label>
          <label class="field">
            <span>Enfermeiro(a) 1</span>
            <input class="input" type="text" id="shiftEnf1">
          </label>
          <label class="field">
            <span>Enfermeiro(a) 2</span>
            <input class="input" type="text" id="shiftEnf2">
          </label>
          <label class="field">
            <span>Auxiliar administrativo</span>
            <input class="input" type="text" id="shiftAux">
          </label>
        </div>
      </div>
      <footer class="modal-footer">
        <button id="btnSaveShift" class="btn btn-primary">Salvar</button>
      </footer>
    </div>
  </div>

  <div id="modalRecord" class="modal-backdrop">
    <div class="modal">
      <header class="modal-header">
        <h3 id="recordTitle">Novo registro</h3>
        <button class="btn btn-ghost" data-close="modalRecord">Fechar</button>
      </header>
      <div class="modal-body" id="recordFields"></div>
      <footer class="modal-footer">
        <button id="btnSaveRecord" class="btn btn-primary">Salvar registro</button>
      </footer>
    </div>
  </div>

  <div id="toastContainer" class="toast-container"></div>
  <div id="loader" class="loader hidden">
    <div class="spinner"></div>
    <span id="loaderText">Salvando...</span>
  </div>

  <script>
    const Api = (() => {
      const run = (name, payload) => new Promise((resolve, reject) => {
        if (typeof google === "undefined" || !google.script || !google.script.run) {
          reject(new Error("google.script.run não disponível."));
          return;
        }

        const runner = google.script.run
          .withSuccessHandler((response) => {
            if (response && response.ok) {
              resolve(response.data);
            } else {
              const message = response && response.error ? response.error.message : "Erro desconhecido";
              reject(new Error(message));
            }
          })
          .withFailureHandler((err) => {
            reject(err);
          });

        if (payload === undefined) {
          runner[name]();
        } else {
          runner[name](payload);
        }
      });

      const runWithArgs = (name, args) => new Promise((resolve, reject) => {
        if (typeof google === "undefined" || !google.script || !google.script.run) {
          reject(new Error("google.script.run não disponível."));
          return;
        }

        const runner = google.script.run
          .withSuccessHandler((response) => {
            if (response && response.ok) {
              resolve(response.data);
            } else {
              const message = response && response.error ? response.error.message : "Erro desconhecido";
              reject(new Error(message));
            }
          })
          .withFailureHandler((err) => {
            reject(err);
          });

        runner[name].apply(runner, args);
      });

      return {
        getAppState: () => run("getAppState"),
        startShift: (payload) => run("startShift", payload),
        updateShift: (payload) => run("updateShift", payload),
        endShift: (payload) => run("endShift", payload),
        readDashboardData: (payload) => run("readDashboardData", payload),
        addRecord: (payload) => run("addRecord", payload),
        deleteRecord: (payload) => run("deleteRecord", payload),
        writeAction: (type, payload) => runWithArgs("writeAction", [type, payload])
      };
    })();

    const UI = (() => {
      const showToast = (type, message) => {
        const container = document.getElementById("toastContainer");
        if (!container) return;
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 4000);
      };

      const setLoader = (visible, message) => {
        const loader = document.getElementById("loader");
        const text = document.getElementById("loaderText");
        if (!loader || !text) return;
        text.textContent = message || "Salvando...";
        loader.classList.toggle("hidden", !visible);
      };

      const toggleModal = (id, show) => {
        const modal = document.getElementById(id);
        if (!modal) return;
        modal.classList.toggle("active", show);
      };

      const renderTable = (wrapperId, table, options) => {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper) return;
        wrapper.innerHTML = "";

        if (!table || !table.headers || table.headers.length === 0) {
          wrapper.innerHTML = '<p class="muted">Nenhum dado cadastrado.</p>';
          return;
        }

        const showDelete = options && options.showDelete;
        const onDelete = options && options.onDelete;

        const tableEl = document.createElement("table");
        const thead = document.createElement("thead");
        const trh = document.createElement("tr");

        table.headers.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          trh.appendChild(th);
        });

        if (showDelete) {
          const th = document.createElement("th");
          th.textContent = "Ações";
          trh.appendChild(th);
        }

        thead.appendChild(trh);
        tableEl.appendChild(thead);

        const tbody = document.createElement("tbody");
        (table.rows || []).forEach((row) => {
          const tr = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell === null || cell === undefined ? "" : cell;
            tr.appendChild(td);
          });

          if (showDelete) {
            const td = document.createElement("td");
            const btn = document.createElement("button");
            btn.className = "btn btn-ghost";
            btn.textContent = "Excluir";
            btn.addEventListener("click", () => onDelete(row[0]));
            td.appendChild(btn);
            tr.appendChild(td);
          }

          tbody.appendChild(tr);
        });

        tableEl.appendChild(tbody);
        wrapper.appendChild(tableEl);
      };

      return {
        showToast,
        setLoader,
        toggleModal,
        renderTable
      };
    })();

    const AppState = (() => {
      const state = {
        view: "confirmadas",
        app: null,
        dashboard: null,
        activeShift: null,
        isSaving: false
      };

      const viewMap = {
        confirmadas: {
          sheet: "RESERVA_CONFIRMADA",
          title: "Reservas confirmadas",
          subtitle: "Pacientes com reserva confirmada para UIB"
        },
        vascular: {
          sheet: "PROCEDIMENTO_VASCULAR",
          title: "Procedimentos vasculares",
          subtitle: "Reservas vinculadas a procedimentos vasculares"
        },
        negadas: {
          sheet: "RESERVA_NEGADA",
          title: "Reservas negadas",
          subtitle: "Reservas canceladas/negadas no plantão"
        },
        anterior: {
          sheet: "PLANTAO_ANTERIOR",
          title: "Plantão anterior",
          subtitle: "Pacientes admitidos na UIB no plantão anterior"
        }
      };

      const moduleConfig = {
        RESERVA_CONFIRMADA: {
          title: "Nova reserva confirmada",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "leito", label: "Leito reservado", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "status", label: "Status", type: "text" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataConfirmacao", label: "Data da confirmação", type: "date" },
            { name: "horaConfirmacao", label: "Hora da confirmação", type: "time" },
            { name: "chegou", label: "Chegou (SIM/NÃO)", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "leito",
            "especialidade",
            "origem",
            "status",
            "dataReserva",
            "horaReserva",
            "dataConfirmacao",
            "horaConfirmacao",
            "tempoAceite",
            "chegou",
            "observacao"
          ]
        },
        PROCEDIMENTO_VASCULAR: {
          title: "Novo procedimento vascular",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "leito", label: "Leito reservado", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "status", label: "Status", type: "text" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataConfirmacao", label: "Data da confirmação", type: "date" },
            { name: "horaConfirmacao", label: "Hora da confirmação", type: "time" },
            { name: "chegou", label: "Chegou (SIM/NÃO)", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "leito",
            "especialidade",
            "origem",
            "status",
            "dataReserva",
            "horaReserva",
            "dataConfirmacao",
            "horaConfirmacao",
            "tempoAceite",
            "chegou",
            "observacao"
          ]
        },
        RESERVA_NEGADA: {
          title: "Nova reserva negada",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "justificativa", label: "Justificativa", type: "textarea" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataCancelamento", label: "Data do cancelamento", type: "date" },
            { name: "horaCancelamento", label: "Hora do cancelamento", type: "time" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "origem",
            "especialidade",
            "justificativa",
            "dataReserva",
            "horaReserva",
            "dataCancelamento",
            "horaCancelamento",
            "tempoCancelamento"
          ]
        },
        PLANTAO_ANTERIOR: {
          title: "Adicionar paciente do plantão anterior",
          fields: [
            { name: "tipo", label: "Tipo", type: "text" },
            { name: "fastmedic", label: "Fastmedic", type: "text" },
            { name: "nome", label: "Nome do paciente", type: "text" },
            { name: "leito", label: "Leito reservado", type: "text" },
            { name: "especialidade", label: "Especialidade", type: "text" },
            { name: "origem", label: "Origem", type: "text" },
            { name: "status", label: "Status", type: "text" },
            { name: "dataReserva", label: "Data da reserva", type: "date" },
            { name: "horaReserva", label: "Hora da reserva", type: "time" },
            { name: "dataAdmissao", label: "Data de admissão", type: "date" },
            { name: "horaAdmissao", label: "Hora de admissão", type: "time" },
            { name: "chegou", label: "Chegou (SIM/NÃO)", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "tipo",
            "fastmedic",
            "nome",
            "leito",
            "especialidade",
            "origem",
            "status",
            "dataReserva",
            "horaReserva",
            "dataAdmissao",
            "horaAdmissao",
            "tempoDecorrido",
            "chegou",
            "observacao"
          ]
        },
        BLOQUEADOS_MANUTENCAO: {
          title: "Novo bloqueio de manutenção",
          fields: [
            { name: "leito", label: "Leito", type: "text" },
            { name: "unidade", label: "Unidade", type: "text" },
            { name: "manutencaoAcionada", label: "Manutenção acionada", type: "text" },
            { name: "dataInicio", label: "Data de início", type: "date" },
            { name: "previsaoReparo", label: "Previsão de reparo", type: "date" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "leito",
            "unidade",
            "manutencaoAcionada",
            "dataInicio",
            "previsaoReparo",
            "observacao"
          ]
        },
        BLOQUEADOS_ISOLAMENTO: {
          title: "Novo bloqueio por isolamento",
          fields: [
            { name: "unidade", label: "Unidade", type: "text" },
            { name: "leito", label: "Leito", type: "text" },
            { name: "paciente", label: "Paciente", type: "text" },
            { name: "tipoIsolamento", label: "Tipo de isolamento", type: "text" },
            { name: "patologia", label: "Patologia", type: "text" },
            { name: "inicioIsolamento", label: "Início do isolamento", type: "date" },
            { name: "tempoPrevisto", label: "Tempo previsto", type: "text" },
            { name: "observacao", label: "Observação", type: "textarea" }
          ],
          rowOrder: [
            "id",
            "unidade",
            "leito",
            "paciente",
            "tipoIsolamento",
            "patologia",
            "inicioIsolamento",
            "tempoPrevisto",
            "observacao"
          ]
        }
      };

      const formatDate = (value) => {
        if (!value) return "-";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        return dt.toLocaleDateString("pt-BR");
      };

      const setShiftSummary = (shift) => {
        const badge = document.getElementById("statusBadge");
        const summary = document.getElementById("shiftSummary");
        const active = Boolean(shift && shift.id);

        badge.textContent = active ? `Plantão ativo ${shift.id}` : "Sem plantão ativo";
        badge.style.background = active ? "rgba(36, 138, 61, 0.12)" : "rgba(215, 0, 21, 0.12)";
        badge.style.color = active ? "var(--success)" : "var(--danger)";

        summary.textContent = active
          ? `Plantão ${shift.id} • ${shift.dayOfWeek || "Dia não informado"} • ${shift.shift || "Turno não informado"} • ${formatDate(shift.date)}`
          : "Nenhum plantão ativo.";

        const info = {
          infoData: formatDate(shift && shift.date),
          infoDia: shift && shift.dayOfWeek ? shift.dayOfWeek : "-",
          infoTurno: shift && shift.shift ? shift.shift : "-",
          infoMed1: shift && shift.team ? shift.team.medico1 : "-",
          infoMed2: shift && shift.team ? shift.team.medico2 : "-",
          infoEnf1: shift && shift.team ? shift.team.enf1 : "-",
          infoEnf2: shift && shift.team ? shift.team.enf2 : "-",
          infoAux: shift && shift.team ? shift.team.aux : "-"
        };

        Object.keys(info).forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.textContent = info[id] || "-";
        });
      };

      const setIndicators = (ind) => {
        if (!ind) return;
        document.getElementById("kpiAlocados").textContent = ind.alocados || 0;
        document.getElementById("kpiConfirmadas").textContent = ind.reservasConfirmadas || 0;
        document.getElementById("kpiCanceladas").textContent = ind.reservasCanceladas || 0;
        document.getElementById("kpiAdmitidos").textContent = ind.admitidosUIB || 0;
      };

      const renderDashboard = () => {
        const dashboard = state.dashboard;
        if (!dashboard) return;

        const viewConfig = viewMap[state.view];
        document.getElementById("principalTitle").textContent = viewConfig.title;
        document.getElementById("principalSubtitle").textContent = viewConfig.subtitle;

        UI.renderTable("principalTable", dashboard.principal, {
          showDelete: true,
          onDelete: (id) => handleDelete(viewConfig.sheet, id, "principal")
        });
        UI.renderTable("manutencaoTable", dashboard.manutencao, {
          showDelete: true,
          onDelete: (id) => handleDelete("BLOQUEADOS_MANUTENCAO", id, "manutencao")
        });
        UI.renderTable("isolamentoTable", dashboard.isolamento, {
          showDelete: true,
          onDelete: (id) => handleDelete("BLOQUEADOS_ISOLAMENTO", id, "isolamento")
        });
      };

      const setTabs = () => {
        document.querySelectorAll(".tab").forEach((tab) => {
          const view = tab.getAttribute("data-view");
          tab.classList.toggle("active", view === state.view);
        });
      };

      const loadApp = async () => {
        UI.setLoader(true, "Carregando...");
        try {
          const app = await Api.getAppState();
          state.app = app;
          state.activeShift = app.activeShift;
          const dashboard = await Api.readDashboardData({ view: state.view });
          state.dashboard = dashboard;
          state.activeShift = dashboard.activeShift || state.activeShift;

          setShiftSummary(state.activeShift);
          setIndicators(dashboard.indicadores);
          renderDashboard();
          setTabs();
        } catch (err) {
          console.error(err);
          UI.showToast("error", "Falha ao carregar o painel.");
        } finally {
          UI.setLoader(false);
        }
      };

      const handleSaveShift = async () => {
        const payload = {
          data: document.getElementById("shiftData").value,
          diaSemana: document.getElementById("shiftDia").value,
          turno: document.getElementById("shiftTurno").value,
          medico1: document.getElementById("shiftMed1").value,
          medico2: document.getElementById("shiftMed2").value,
          enf1: document.getElementById("shiftEnf1").value,
          enf2: document.getElementById("shiftEnf2").value,
          aux: document.getElementById("shiftAux").value
        };

        const previous = state.activeShift;
        const optimistic = {
          id: previous && previous.id ? previous.id : "SALVANDO",
          date: payload.data,
          dayOfWeek: payload.diaSemana,
          shift: payload.turno,
          team: {
            medico1: payload.medico1,
            medico2: payload.medico2,
            enf1: payload.enf1,
            enf2: payload.enf2,
            aux: payload.aux
          },
          startedAt: previous && previous.startedAt ? previous.startedAt : new Date().toISOString()
        };

        state.activeShift = optimistic;
        setShiftSummary(state.activeShift);
        UI.setLoader(true, previous ? "Atualizando plantão..." : "Abrindo plantão...");

        try {
          const response = previous
            ? await Api.updateShift(payload)
            : await Api.startShift(payload);

          state.activeShift = response.activeShift;
          setShiftSummary(state.activeShift);
          UI.toggleModal("modalShift", false);
          UI.showToast("success", "Plantão salvo com sucesso.");
          await loadApp();
        } catch (err) {
          console.error(err);
          state.activeShift = previous;
          setShiftSummary(state.activeShift);
          UI.showToast("error", err.message || "Erro ao salvar plantão.");
        } finally {
          UI.setLoader(false);
        }
      };

      const handleEndShift = async () => {
        if (!state.activeShift || !state.activeShift.id) {
          UI.showToast("info", "Nenhum plantão ativo.");
          return;
        }

        if (!confirm("Encerrar o plantão atual?")) return;

        const previous = state.activeShift;
        state.activeShift = null;
        setShiftSummary(state.activeShift);
        UI.setLoader(true, "Encerrando plantão...");

        try {
          await Api.endShift(previous.id);
          UI.showToast("success", "Plantão encerrado.");
          await loadApp();
        } catch (err) {
          console.error(err);
          state.activeShift = previous;
          setShiftSummary(state.activeShift);
          UI.showToast("error", err.message || "Erro ao encerrar plantão.");
        } finally {
          UI.setLoader(false);
        }
      };

      const handleDelete = async (moduleName, id, tableKey) => {
        if (!id) {
          UI.showToast("info", "Registro sem ID.");
          return;
        }
        if (!confirm("Excluir esse registro?")) return;

        const previous = JSON.parse(JSON.stringify(state.dashboard[tableKey]));
        state.dashboard[tableKey].rows = state.dashboard[tableKey].rows.filter((row) => String(row[0]) !== String(id));
        renderDashboard();
        UI.setLoader(true, "Excluindo registro...");

        try {
          await Api.deleteRecord({ modulo: moduleName, id: String(id) });
          UI.showToast("success", "Registro excluído.");
          await loadApp();
        } catch (err) {
          console.error(err);
          state.dashboard[tableKey] = previous;
          renderDashboard();
          UI.showToast("error", err.message || "Erro ao excluir.");
        } finally {
          UI.setLoader(false);
        }
      };

      const handleAddRecord = (moduleName) => {
        const config = moduleConfig[moduleName];
        if (!config) return;
        const body = document.getElementById("recordFields");
        body.innerHTML = "";
        document.getElementById("recordTitle").textContent = config.title;

        config.fields.forEach((field) => {
          const wrapper = document.createElement("label");
          wrapper.className = "field";
          const span = document.createElement("span");
          span.textContent = field.label;
          const input = field.type === "textarea" ? document.createElement("textarea") : document.createElement("input");
          input.className = field.type === "textarea" ? "textarea" : "input";
          input.type = field.type === "textarea" ? "text" : field.type;
          input.dataset.name = field.name;
          wrapper.appendChild(span);
          wrapper.appendChild(input);
          body.appendChild(wrapper);
        });

        body.dataset.module = moduleName;
        UI.toggleModal("modalRecord", true);
      };

      const handleSaveRecord = async () => {
        const body = document.getElementById("recordFields");
        const moduleName = body.dataset.module;
        const config = moduleConfig[moduleName];
        if (!config) return;

        const record = {};
        body.querySelectorAll("[data-name]").forEach((input) => {
          record[input.dataset.name] = input.value || "";
        });

        const optimisticRow = config.rowOrder.map((key) => {
          if (key === "id") return "SALVANDO";
          return record[key] || "";
        });

        const tableKey = moduleName === viewMap[state.view].sheet ? "principal" : moduleName === "BLOQUEADOS_MANUTENCAO" ? "manutencao" : "isolamento";
        state.dashboard[tableKey].rows.unshift(optimisticRow);
        renderDashboard();
        UI.setLoader(true, "Salvando registro...");

        try {
          await Api.addRecord({ modulo: moduleName, registro: record });
          UI.toggleModal("modalRecord", false);
          UI.showToast("success", "Registro salvo.");
          await loadApp();
        } catch (err) {
          console.error(err);
          state.dashboard[tableKey].rows = state.dashboard[tableKey].rows.filter((row) => row[0] !== "SALVANDO");
          renderDashboard();
          UI.showToast("error", err.message || "Erro ao salvar registro.");
        } finally {
          UI.setLoader(false);
        }
      };

      const openShiftModal = () => {
        const shift = state.activeShift;
        document.getElementById("shiftData").value = shift && shift.date ? shift.date : "";
        document.getElementById("shiftDia").value = shift && shift.dayOfWeek ? shift.dayOfWeek : "";
        document.getElementById("shiftTurno").value = shift && shift.shift ? shift.shift : "";
        document.getElementById("shiftMed1").value = shift && shift.team ? shift.team.medico1 : "";
        document.getElementById("shiftMed2").value = shift && shift.team ? shift.team.medico2 : "";
        document.getElementById("shiftEnf1").value = shift && shift.team ? shift.team.enf1 : "";
        document.getElementById("shiftEnf2").value = shift && shift.team ? shift.team.enf2 : "";
        document.getElementById("shiftAux").value = shift && shift.team ? shift.team.aux : "";
        UI.toggleModal("modalShift", true);
      };

      const initEvents = () => {
        document.getElementById("btnRefresh").addEventListener("click", loadApp);
        document.getElementById("btnStartShift").addEventListener("click", openShiftModal);
        document.getElementById("btnEditShift").addEventListener("click", openShiftModal);
        document.getElementById("btnEndShift").addEventListener("click", handleEndShift);
        document.getElementById("btnSaveShift").addEventListener("click", handleSaveShift);
        document.getElementById("btnSaveRecord").addEventListener("click", handleSaveRecord);
        document.getElementById("btnAddPrincipal").addEventListener("click", () => handleAddRecord(viewMap[state.view].sheet));
        document.getElementById("btnAddManutencao").addEventListener("click", () => handleAddRecord("BLOQUEADOS_MANUTENCAO"));
        document.getElementById("btnAddIsolamento").addEventListener("click", () => handleAddRecord("BLOQUEADOS_ISOLAMENTO"));

        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            state.view = tab.dataset.view;
            setTabs();
            loadApp();
          });
        });

        document.querySelectorAll("[data-close]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-close");
            UI.toggleModal(target, false);
          });
        });
      };

      return {
        init: () => {
          initEvents();
          loadApp();
        }
      };
    })();

    document.addEventListener("DOMContentLoaded", () => {
      AppState.init();
    });
  </script>
</body>
</html>
