<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ocorr√™ncias do Plant√£o ‚Äì NIR</title>
  <style>
  :root {
    --bg-page: #f5f5f7;
    --bg-card: #ffffff;
    --bg-header: #fbfbfd;
    --border-subtle: #e5e5ea;
    --border-strong: #d2d2d7;
    --accent: #007aff;
    --accent-soft: #e6f0ff;
    --accent-strong: #0056d6;
    --text-main: #1d1d1f;
    --text-soft: #6e6e73;
    --text-muted: #86868b;
    --danger: #d70015;
    --success: #248a3d;
    --warning: #b25000;
    --radius-md: 10px;
    --radius-lg: 14px;
    --shadow-soft: 0 18px 40px rgba(0,0,0,0.08);
  }

  * {
    box-sizing: border-box;
    font-family: "SF Pro Text", "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    padding: 16px;
    background: var(--bg-page);
    color: var(--text-main);
    font-size: 14px;
  }

  .system-wrapper {
    max-width: 1320px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .system-menu {
    display: flex;
    gap: 8px;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 6px;
    box-shadow: var(--shadow-soft);
  }

  .menu-item {
    border: 1px solid transparent;
    border-radius: 10px;
    padding: 10px 14px;
    background: transparent;
    color: var(--text-main);
    font-weight: 600;
    cursor: pointer;
    transition: 0.16s ease all;
    display: inline-flex;
    gap: 8px;
    align-items: center;
  }

  .menu-item span {
    font-size: 12px;
    color: var(--text-soft);
    font-weight: 500;
  }

  .menu-item.active {
    background: var(--accent);
    border-color: var(--accent-strong);
    color: #ffffff;
    box-shadow: 0 12px 30px rgba(0, 122, 255, 0.2);
  }

  .menu-panels {
    width: 100%;
  }

  .menu-panel {
    display: none;
  }

  .menu-panel.active {
    display: block;
  }

  .placeholder-card {
    background: var(--bg-card);
    border-radius: 14px;
    border: 1px solid var(--border-subtle);
    padding: 20px;
    box-shadow: var(--shadow-soft);
  }

  .placeholder-title {
    margin: 0 0 8px;
    font-size: 16px;
    font-weight: 600;
  }

  .placeholder-subtitle {
    margin: 0;
    color: var(--text-soft);
    font-size: 13px;
  }

  .app-shell {
    max-width: 1280px;
    margin: 0 auto;
    background: var(--bg-card);
    border-radius: 16px;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--border-subtle);
    overflow: hidden;
  }

  .app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    background: var(--bg-header);
    border-bottom: 1px solid var(--border-subtle);
  }

  .app-title {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .app-title h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-main);
  }

  .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    background: var(--accent-soft);
    color: var(--accent-strong);
    border: 1px solid #d0e2ff;
  }

  .app-subtitle {
    font-size: 12px;
    color: var(--text-soft);
  }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--text-soft);
    background: #f2f2f7;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid var(--border-subtle);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: var(--warning);
  }

  .btn {
    border-radius: 6px;
    border: 1px solid transparent;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #e5e5ea;
    color: var(--text-main);
    transition: 0.16s ease all;
  }

  .btn:hover {
    background: #d1d1d6;
  }

  .btn-primary {
    background: var(--accent);
    color: #ffffff;
    border-color: var(--accent-strong);
  }

  .btn-primary:hover {
    background: var(--accent-strong);
  }

  .btn-danger {
    background: #ffe5e5;
    color: var(--danger);
    border-color: #ffd1d1;
  }

  .btn-danger:hover {
    background: #ffd1d1;
  }

  .btn-link {
    background: transparent;
    border-color: transparent;
    color: var(--accent-strong);
    padding-left: 0;
    padding-right: 0;
  }

  .btn-small {
    padding: 4px 10px;
    font-size: 12px;
  }

  .content {
    padding: 16px 20px 18px;
    background: #f9f9fb;
  }

  .section {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle);
    padding: 14px 16px 16px;
    margin-bottom: 12px;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 10px;
    gap: 12px;
  }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-main);
  }

  .section-subtitle {
    font-size: 12px;
    color: var(--text-soft);
  }

  .chip {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid var(--border-subtle);
    background: #f2f2f7;
    color: var(--text-soft);
  }

  .row-space {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .team-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    margin-top: 8px;
  }

  .team-card {
    background: #f8f8fb;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    padding: 8px 10px;
  }

  .team-label {
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.02em;
    margin-bottom: 2px;
    text-transform: uppercase;
  }

  .team-value {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-main);
  }

  .team-empty {
    padding: 6px 8px;
    color: var(--text-soft);
    font-size: 12px;
  }

  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
    margin-top: 6px;
  }

  .kpi-card {
    background: #eef4ff;
    border-radius: var(--radius-md);
    padding: 10px 12px;
    border: 1px solid #d7e7ff;
  }

  .kpi-label {
    font-size: 12px;
    color: var(--text-soft);
    margin-bottom: 2px;
  }

  .kpi-value {
    font-size: 20px;
    font-weight: 600;
    color: var(--accent-strong);
  }

  .kpi-tag {
    font-size: 11px;
    color: var(--text-soft);
  }

  .tabs {
    display: inline-flex;
    border-radius: 999px;
    background: #e5e5ea;
    padding: 3px;
    gap: 3px;
  }

  .tab {
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 12px;
    border: none;
    background: transparent;
    color: var(--text-soft);
    cursor: pointer;
  }

  .tab.active {
    background: #ffffff;
    color: var(--accent-strong);
    box-shadow: 0 0 0 1px #d1d1d6;
  }

  .table-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    margin-top: 4px;
    gap: 12px;
  }

  .table-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-main);
  }

  .table-subtitle {
    font-size: 12px;
    color: var(--text-soft);
  }

  .table-wrapper {
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
    overflow: auto;
    background: #ffffff;
    max-height: 320px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    min-width: 720px;
  }

  thead {
    background: #eef4ff;
    border-bottom: 1px solid #d7e7ff;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  th, td {
    padding: 6px 8px;
    border-bottom: 1px solid #ededf0;
    text-align: left;
    white-space: nowrap;
  }

  th {
    font-weight: 500;
    color: var(--text-soft);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  tbody tr:nth-child(even) {
    background-color: #f9f9fb;
  }

  tbody tr:hover td {
    background-color: #eef4ff;
  }

  .btn-table {
    border-radius: 4px;
    border: 1px solid var(--border-strong);
    background: #ffffff;
    color: var(--danger);
    font-size: 11px;
    padding: 3px 8px;
    cursor: pointer;
  }

  .btn-table:hover {
    background: #ffe5e5;
    border-color: #ffd1d1;
  }

  .subsection-title {
    font-size: 12px;
    color: var(--text-soft);
    margin: 10px 0 4px;
    font-weight: 500;
  }

  .mt-2 { margin-top: 8px; }
  .mt-4 { margin-top: 12px; }

  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .modal-backdrop.visible {
    display: flex;
  }

  .modal {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    border: 1px solid var(--border-subtle);
    max-width: 520px;
    width: 100%;
    max-height: 90vh;
    overflow: auto;
    padding: 16px 18px 14px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .modal-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-main);
  }

  .modal-body {
    font-size: 13px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 12px;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 3px;
    margin-bottom: 8px;
  }

  .field label {
    font-size: 12px;
    color: var(--text-soft);
  }

  .field input,
  .field select,
  .field textarea {
    border-radius: 6px;
    border: 1px solid var(--border-strong);
    padding: 6px 8px;
    font-size: 13px;
    outline: none;
    background-color: #ffffff;
    color: var(--text-main);
  }

  .field input:focus,
  .field select:focus,
  .field textarea:focus {
    border-color: var(--accent-strong);
    box-shadow: 0 0 0 1px var(--accent-soft);
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  @media (max-width: 960px) {
    .kpi-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .row-space {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  @media (max-width: 720px) {
    .kpi-grid {
      grid-template-columns: 1fr;
    }
    .content {
      padding: 12px;
    }
    .app-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
  }

  .hidden { display: none !important; }
  .loading-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: #eef4ff;
    border: 1px solid #d7e7ff;
    border-radius: 999px;
    color: #1d4ed8;
    font-size: 12px;
    box-shadow: 0 10px 20px rgba(0,122,255,0.12);
  }

  .spinner {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #c7d2fe;
    border-top-color: #4f46e5;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

</head>
<body>
  <div class="system-wrapper">
    <nav class="system-menu">
      <button class="menu-item active" data-target="painel-ocorrencias" onclick="selecionarMenu('painel-ocorrencias')">
        Ocorr√™ncias NIR
        <span>Op√ß√£o principal</span>
      </button>
      <button class="menu-item" data-target="painel-opcao2" onclick="selecionarMenu('painel-opcao2')">
        Op√ß√£o 2
        <span>Em breve</span>
      </button>
      <button class="menu-item" data-target="painel-opcao3" onclick="selecionarMenu('painel-opcao3')">
        Op√ß√£o 3
        <span>Em breve</span>
      </button>
    </nav>

    <div class="menu-panels">
      <div id="painel-ocorrencias" class="menu-panel active">
        <div class="app-shell">
          <header class="app-header">
            <div class="app-title">
              <h1>
                Ocorr√™ncias do Plant√£o ‚Äì NIR
          <span class="badge">HUC ‚Ä¢ NIR</span>
              </h1>
              <span id="plantaoResumo" class="app-subtitle">
                Nenhum plant√£o ativo. Clique em "Abrir Plant√£o" para iniciar.
              </span>
            </div>
            <div class="header-actions">
              <div class="status-pill">
                <span id="dotStatus" class="status-dot"></span>
                <span id="statusText">Sem plant√£o ativo</span>
              </div>
              <div id="loadingIndicator" class="loading-indicator hidden" aria-live="polite">
                <span class="spinner" aria-hidden="true"></span>
                <span id="loadingText">Processando...</span>
              </div>
              <button class="btn btn-small" onclick="carregarApp()" title="Recarrega dados da planilha">
                ‚ü≥ Atualizar dados
              </button>
              <button class="btn btn-link btn-small" onclick="abrirModalEquipeEdicao()">
                üë• Equipe do Plant√£o
              </button>
              <button class="btn btn-small" onclick="salvarPlantao()">
                üíæ Salvar Equipe
              </button>
              <button class="btn btn-primary btn-small" onclick="abrirPlantao()">
                ‚ñ∂ Abrir Plant√£o
              </button>
              <button class="btn btn-danger btn-small" onclick="encerrarPlantao()">
                ‚èπ Encerrar
              </button>
            </div>
          </header>

          <div class="content">
      <!-- Equipe do plant√£o -->
      <section class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Equipe do Plant√£o</div>
            <div class="section-subtitle">Mostrada automaticamente para o plant√£o ativo</div>
          </div>
          <div class="chip" id="equipeStatusChip">Nenhum plant√£o ativo</div>
        </div>
        <div id="equipeSemPlantao" class="team-empty">
          Nenhum plant√£o ativo. Clique em "Abrir Plant√£o" para definir a equipe.
        </div>
        <div id="equipeGrid" class="team-grid hidden" aria-live="polite">
          <div class="team-card">
            <div class="team-label">Data</div>
            <div class="team-value" id="eq-data">-</div>
          </div>
          <div class="team-card">
            <div class="team-label">Dia</div>
            <div class="team-value" id="eq-dia">-</div>
          </div>
          <div class="team-card">
            <div class="team-label">Turno</div>
            <div class="team-value" id="eq-turno">-</div>
          </div>
          <div class="team-card">
            <div class="team-label">M√©dico(a) 1</div>
            <div class="team-value" id="eq-med1">-</div>
          </div>
          <div class="team-card">
            <div class="team-label">M√©dico(a) 2</div>
            <div class="team-value" id="eq-med2">-</div>
          </div>
          <div class="team-card">
            <div class="team-label">Enfermeiro(a) 1</div>
            <div class="team-value" id="eq-enf1">-</div>
          </div>
          <div class="team-card">
            <div class="team-label">Enfermeiro(a) 2</div>
            <div class="team-value" id="eq-enf2">-</div>
          </div>
          <div class="team-card">
            <div class="team-label">Auxiliar Administrativo</div>
            <div class="team-value" id="eq-aux">-</div>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Indicadores do Plant√£o</div>
            <div class="section-subtitle">Resumo das reservas, negativas e admiss√µes</div>
          </div>
          <div class="chip">
            Plant√£o atual
          </div>
        </div>
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Pacientes Alocados</div>
            <div class="kpi-value" id="kpi-alocados">0</div>
            <div class="kpi-tag">Confirmadas + Vascular</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Reservas Confirmadas</div>
            <div class="kpi-value" id="kpi-confirmadas">0</div>
            <div class="kpi-tag">Ativas</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Reservas Canceladas</div>
            <div class="kpi-value" id="kpi-canceladas">0</div>
            <div class="kpi-tag">Negadas</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Admitidos na UIB</div>
            <div class="kpi-value" id="kpi-admitidos">0</div>
            <div class="kpi-tag">Plant√£o anterior</div>
          </div>
        </div>
      </section>

      <!-- Pacientes / Reservas -->
      <section class="section">
        <div class="row-space">
          <div>
            <div class="section-title">Pacientes e Reservas</div>
            <div class="section-subtitle" id="tituloPrincipal">
              PACIENTES COM RESERVA CONFIRMADA
            </div>
          </div>
          <div class="tabs">
            <button class="tab active" data-view="confirmadas" onclick="mudarView(this)">Confirmadas</button>
            <button class="tab" data-view="vascular" onclick="mudarView(this)">Proced. Vascular</button>
            <button class="tab" data-view="negadas" onclick="mudarView(this)">Reservas Negadas</button>
            <button class="tab" data-view="anterior" onclick="mudarView(this)">Plant√£o Anterior</button>
          </div>
        </div>

        <div class="table-header-row">
          <div>
            <div class="table-title" id="tableTitlePrincipal">Reservas Confirmadas</div>
            <div class="table-subtitle" id="tableSubtitlePrincipal">Pacientes com reserva confirmada para UIB</div>
          </div>
          <button class="btn btn-primary btn-small" onclick="abrirModalRegistroPrincipal()">
            + Adicionar Registro
          </button>
        </div>

        <div class="table-wrapper" id="tabelaPrincipalWrapper">
          <!-- tabela principal via JS -->
        </div>

        <!-- BLOQUEIOS -->
        <div class="mt-4">
          <div class="table-header-row">
            <div>
              <div class="subsection-title">Bloqueados para Manuten√ß√£o</div>
            </div>
            <button class="btn btn-small" onclick="abrirModalRegistro('BLOQUEADOS_MANUTENCAO')">
              + Adicionar Manuten√ß√£o
            </button>
          </div>
          <div class="table-wrapper" id="tabelaManutencaoWrapper" style="max-height: 220px;">
            <!-- tabela -->
          </div>
        </div>

        <div class="mt-4">
          <div class="table-header-row">
            <div>
              <div class="subsection-title">Bloqueados por Isolamento</div>
            </div>
            <button class="btn btn-small" onclick="abrirModalRegistro('BLOQUEADOS_ISOLAMENTO')">
              + Adicionar Isolamento
            </button>
          </div>
          <div class="table-wrapper" id="tabelaIsolamentoWrapper" style="max-height: 220px;">
            <!-- tabela -->
          </div>
        </div>
      </section>
    </div>
  </div>

        <!-- MODAL EQUIPE -->
        <div id="modalEquipeBackdrop" class="modal-backdrop">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">Equipe do Plant√£o</div>
              <button class="btn btn-link btn-small" onclick="fecharModalEquipe()">Fechar</button>
            </div>
            <div class="modal-body">
              <div class="field">
                <label>ID do Plant√£o</label>
                <input id="me-id" type="text" readonly placeholder="Ser√° gerado ao abrir plant√£o">
              </div>

              <div class="field">
                <label>Data do Plant√£o</label>
                <input id="me-data" type="date">
              </div>

              <div class="field">
                <label>Dia da Semana</label>
                <input id="me-dia" type="text" placeholder="Ex: Segunda">
              </div>

              <div class="field">
                <label>Turno</label>
                <select id="me-turno">
                  <option value="">Selecione...</option>
                  <option>Manh√£</option>
                  <option>Tarde</option>
                  <option>Noite</option>
                </select>
              </div>

              <div class="field">
                <label>M√©dico(a) 1</label>
                <input id="me-med1" type="text">
              </div>
              <div class="field">
                <label>M√©dico(a) 2</label>
                <input id="me-med2" type="text">
              </div>

              <div class="field">
                <label>Enfermeiro(a) 1</label>
                <input id="me-enf1" type="text">
              </div>
              <div class="field">
                <label>Enfermeiro(a) 2</label>
                <input id="me-enf2" type="text">
              </div>

              <div class="field">
                <label>Auxiliar Administrativo</label>
                <input id="me-aux" type="text">
              </div>

              <div class="field">
                <label>Abertura</label>
                <input id="me-abertura" type="text" readonly>
              </div>

              <div class="field">
                <label>Encerramento</label>
                <input id="me-encerramento" type="text" readonly>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-small" onclick="fecharModalEquipe()">Cancelar</button>
              <button class="btn btn-primary btn-small" onclick="salvarEquipeModal()">
                Salvar
              </button>
            </div>
          </div>
        </div>

        <!-- MODAL REGISTRO -->
        <div id="modalRegistroBackdrop" class="modal-backdrop">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title" id="modalRegistroTitulo">Novo Registro</div>
              <button class="btn btn-link btn-small" onclick="fecharModalRegistro()">Fechar</button>
            </div>
            <div class="modal-body" id="modalRegistroBody">
              <!-- campos via JS -->
            </div>
            <div class="modal-footer">
              <button class="btn btn-small" onclick="fecharModalRegistro()">Cancelar</button>
              <button class="btn btn-primary btn-small" onclick="salvarRegistroModal()">
                Salvar
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="painel-opcao2" class="menu-panel">
        <div class="placeholder-card">
          <h3 class="placeholder-title">Op√ß√£o 2</h3>
          <p class="placeholder-subtitle">√Årea reservada para futuros m√≥dulos do sistema.</p>
        </div>
      </div>

      <div id="painel-opcao3" class="menu-panel">
        <div class="placeholder-card">
          <h3 class="placeholder-title">Op√ß√£o 3</h3>
          <p class="placeholder-subtitle">Conte√∫do a definir. Esta op√ß√£o j√° fica pronta no menu.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
  let estadoAtual = {
    view: "confirmadas",
    principalModulo: "RESERVA_CONFIRMADA",
    moduloRegistroAtual: null,
    plantaoAtivo: false
  };

  const menuPainelIds = ["painel-ocorrencias", "painel-opcao2", "painel-opcao3"];
  const googleScriptDisponivel = typeof google !== "undefined" && google.script && google.script.run;

  const viewToModulo = {
    confirmadas: "RESERVA_CONFIRMADA",
    vascular: "PROCEDIMENTO_VASCULAR",
    negadas: "RESERVA_NEGADA",
    anterior: "PLANTAO_ANTERIOR"
  };

  const moduleConfig = {
    "RESERVA_CONFIRMADA": {
      titulo: "Nova Reserva Confirmada",
      campos: [
        { name: "tipo", label: "Tipo", type: "text" },
        { name: "fastmedic", label: "Fastmedic", type: "text" },
        { name: "nome", label: "Nome do Paciente", type: "text" },
        { name: "leito", label: "Leito Reservado", type: "text" },
        { name: "especialidade", label: "Especialidade", type: "text" },
        { name: "origem", label: "Origem", type: "text" },
        { name: "status", label: "Status", type: "text" },
        { name: "dataReserva", label: "Data da Reserva", type: "date" },
        { name: "horaReserva", label: "Hora da Reserva", type: "time" },
        { name: "dataConfirmacao", label: "Data da Confirma√ß√£o", type: "date" },
        { name: "horaConfirmacao", label: "Hora da Confirma√ß√£o", type: "time" },
        { name: "chegou", label: "Chegou (SIM/N√ÉO)", type: "text" },
        { name: "observacao", label: "Observa√ß√£o", type: "textarea" }
      ]
    },
    "PROCEDIMENTO_VASCULAR": {
      titulo: "Novo Procedimento Vascular",
      campos: [
        { name: "tipo", label: "Tipo", type: "text" },
        { name: "fastmedic", label: "Fastmedic", type: "text" },
        { name: "nome", label: "Nome do Paciente", type: "text" },
        { name: "leito", label: "Leito Reservado", type: "text" },
        { name: "especialidade", label: "Especialidade", type: "text" },
        { name: "origem", label: "Origem", type: "text" },
        { name: "status", label: "Status", type: "text" },
        { name: "dataReserva", label: "Data da Reserva", type: "date" },
        { name: "horaReserva", label: "Hora da Reserva", type: "time" },
        { name: "dataConfirmacao", label: "Data da Confirma√ß√£o", type: "date" },
        { name: "horaConfirmacao", label: "Hora da Confirma√ß√£o", type: "time" },
        { name: "chegou", label: "Chegou (SIM/N√ÉO)", type: "text" },
        { name: "observacao", label: "Observa√ß√£o", type: "textarea" }
      ]
    },
    "RESERVA_NEGADA": {
      titulo: "Nova Reserva Negada",
      campos: [
        { name: "tipo", label: "Tipo", type: "text" },
        { name: "fastmedic", label: "Fastmedic", type: "text" },
        { name: "nome", label: "Nome do Paciente", type: "text" },
        { name: "origem", label: "Origem", type: "text" },
        { name: "especialidade", label: "Especialidade", type: "text" },
        { name: "justificativa", label: "Justificativa", type: "textarea" },
        { name: "dataReserva", label: "Data da Reserva", type: "date" },
        { name: "horaReserva", label: "Hora da Reserva", type: "time" },
        { name: "dataCancelamento", label: "Data do Cancelamento", type: "date" },
        { name: "horaCancelamento", label: "Hora do Cancelamento", type: "time" }
      ]
    },
    "PLANTAO_ANTERIOR": {
      titulo: "Adicionar Paciente do Plant√£o Anterior",
      campos: [
        { name: "tipo", label: "Tipo", type: "text" },
        { name: "fastmedic", label: "Fastmedic", type: "text" },
        { name: "nome", label: "Nome do Paciente", type: "text" },
        { name: "leito", label: "Leito Reservado", type: "text" },
        { name: "especialidade", label: "Especialidade", type: "text" },
        { name: "origem", label: "Origem", type: "text" },
        { name: "status", label: "Status", type: "text" },
        { name: "dataReserva", label: "Data da Reserva", type: "date" },
        { name: "horaReserva", label: "Hora da Reserva", type: "time" },
        { name: "dataAdmissao", label: "Data de Admiss√£o", type: "date" },
        { name: "horaAdmissao", label: "Hora de Admiss√£o", type: "time" },
        { name: "chegou", label: "Chegou (SIM/N√ÉO)", type: "text" },
        { name: "observacao", label: "Observa√ß√£o", type: "textarea" }
      ]
    },
    "BLOQUEADOS_MANUTENCAO": {
      titulo: "Novo Leito Bloqueado para Manuten√ß√£o",
      campos: [
        { name: "leito", label: "Leito", type: "text" },
        { name: "unidade", label: "Unidade", type: "text" },
        { name: "manutencaoAcionada", label: "Manuten√ß√£o Acionada", type: "text" },
        { name: "dataInicio", label: "Data de In√≠cio", type: "date" },
        { name: "previsaoReparo", label: "Previs√£o de Reparo", type: "date" },
        { name: "observacao", label: "Observa√ß√£o", type: "textarea" }
      ]
    },
    "BLOQUEADOS_ISOLAMENTO": {
      titulo: "Novo Leito em Isolamento",
      campos: [
        { name: "unidade", label: "Unidade", type: "text" },
        { name: "leito", label: "Leito", type: "text" },
        { name: "paciente", label: "Paciente", type: "text" },
        { name: "tipoIsolamento", label: "Tipo de Isolamento", type: "text" },
        { name: "patologia", label: "Patologia", type: "text" },
        { name: "inicioIsolamento", label: "In√≠cio do Isolamento", type: "date" },
        { name: "tempoPrevisto", label: "Tempo Previsto", type: "text" },
        { name: "observacao", label: "Observa√ß√£o", type: "textarea" }
      ]
    }
  };

  function selecionarMenu(targetId) {
    menuPainelIds.forEach(id => {
      const painel = document.getElementById(id);
      if (painel) painel.classList.toggle("active", id === targetId);

      const botao = document.querySelector(`.menu-item[data-target="${id}"]`);
      if (botao) botao.classList.toggle("active", id === targetId);
    });

    if (targetId === "painel-ocorrencias" && googleScriptDisponivel) {
      carregarApp("confirmadas");
    }
  }

  function parseDataFlexivel(valor) {
    if (valor === null || valor === undefined || valor === "") return null;
    if (Object.prototype.toString.call(valor) === "[object Date]") {
      return isNaN(valor) ? null : new Date(valor);
    }

    if (typeof valor === "number") {
      const base = new Date(Date.UTC(1899, 11, 30));
      const millis = valor * 24 * 60 * 60 * 1000;
      const dtSerial = new Date(base.getTime() + millis);
      return isNaN(dtSerial) ? null : dtSerial;
    }

    const str = String(valor).trim();
    if (!str) return null;

    const normalizado = str.replace(/\s+/g, " ").replace(/-/g, "/");
    const br = normalizado.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{2,4})(?:[ T](\d{1,2})[:hH]?(\d{1,2}))?/);
    if (br) {
      const dia = Number(br[1]);
      const mes = Number(br[2]) - 1;
      let ano = Number(br[3]);
      if (ano < 100) ano += 2000;
      const hora = Number(br[4] || 0);
      const minuto = Number(br[5] || 0);
      const candidato = new Date(ano, mes, dia, hora, minuto);
      if (!isNaN(candidato)) return candidato;
    }

    const isoLike = new Date(str.replace(/ /g, "T"));
    if (!isNaN(isoLike)) return isoLike;

    const dt = new Date(str);
    return isNaN(dt) ? null : dt;
  }

  function formatarDataHora(d) {
    const dt = parseDataFlexivel(d);
    if (!dt) return "";
    const dia = String(dt.getDate()).padStart(2, "0");
    const mes = String(dt.getMonth() + 1).padStart(2, "0");
    const ano = dt.getFullYear();
    const hh = String(dt.getHours()).padStart(2, "0");
    const mm = String(dt.getMinutes()).padStart(2, "0");
    return `${dia}/${mes}/${ano} ${hh}:${mm}`;
  }

  function formatarDataParaInput(d) {
    const dt = parseDataFlexivel(d);
    if (!dt) return "";
    return dt.toISOString().slice(0, 10);
  }

  function formatarDataCurta(d) {
    const dt = parseDataFlexivel(d);
    if (!dt) return "";
    const dia = String(dt.getDate()).padStart(2, "0");
    const mes = String(dt.getMonth() + 1).padStart(2, "0");
    const ano = dt.getFullYear();
    return `${dia}/${mes}/${ano}`;
  }

  function setLoading(visivel, mensagem) {
    const indicador = document.getElementById("loadingIndicator");
    const texto = document.getElementById("loadingText");
    if (!indicador || !texto) return;
    if (mensagem) texto.textContent = mensagem;
    indicador.classList.toggle("hidden", !visivel);
  }

  function carregarApp(view) {
    if (!googleScriptDisponivel) return;
    const v = view || estadoAtual.view;
    estadoAtual.view = v;
    setLoading(true, "Carregando dados...");
    google.script.run
      .withSuccessHandler(function (data) {
        preencherPlantao(data.plantao);
        preencherIndicadores(data.indicadores);
        estadoAtual.principalModulo = data.principalNome;
        renderTabela("tabelaPrincipalWrapper", data.principal, true, data.principalNome);
        renderTabela("tabelaManutencaoWrapper", data.manutencao, false, "BLOQUEADOS_MANUTENCAO");
        renderTabela("tabelaIsolamentoWrapper", data.isolamento, false, "BLOQUEADOS_ISOLAMENTO");
        atualizarStatus(data.plantao);
        atualizarTitulosPrincipal(v);
        setLoading(false);
      })
      .withFailureHandler(function (err) {
        console.error(err);
        alert("Erro ao carregar dados: " + err.message);
        setLoading(false);
      })
      .getAppData(v);
  }

  function preencherPlantao(pl) {
    const resumo = document.getElementById("plantaoResumo");
    const dot = document.getElementById("dotStatus");
    const text = document.getElementById("statusText");

    const ativo = Boolean(pl && (pl.ativo || pl.id || pl.possuiConteudo));

    if (!ativo) {
      estadoAtual.plantaoAtivo = false;
      resumo.textContent = 'Nenhum plant√£o ativo. Clique em "Abrir Plant√£o" para iniciar.';
      dot.style.background = "#b25000";
      text.textContent = "Sem plant√£o ativo";

      renderEquipe(null);

      document.getElementById("me-id").value = "";
      document.getElementById("me-data").value = "";
      document.getElementById("me-dia").value = "";
      document.getElementById("me-turno").value = "";
      document.getElementById("me-med1").value = "";
      document.getElementById("me-med2").value = "";
      document.getElementById("me-enf1").value = "";
      document.getElementById("me-enf2").value = "";
      document.getElementById("me-aux").value = "";
      document.getElementById("me-abertura").value = "";
      document.getElementById("me-encerramento").value = "";
      return;
    }

    estadoAtual.plantaoAtivo = true;

    const dataInput = formatarDataParaInput(pl.data);
    const dataStr = formatarDataCurta(pl.data) || dataInput || pl.data || "-";

    resumo.textContent =
      `Plant√£o ${pl.id} ‚Ä¢ ${pl.diaSemana || "Dia n√£o informado"} ‚Ä¢ ${pl.turno || "Turno n√£o informado"} ‚Ä¢ Data: ${dataStr}`;
    dot.style.background = "#248a3d";
    text.textContent = "Plant√£o ativo";

    renderEquipe({
      data: dataStr,
      dia: pl.diaSemana,
      turno: pl.turno,
      med1: pl.medico1,
      med2: pl.medico2,
      enf1: pl.enf1,
      enf2: pl.enf2,
      aux: pl.aux
    });

    document.getElementById("me-id").value = pl.id || "";
    if (dataInput) document.getElementById("me-data").value = dataInput;
    document.getElementById("me-dia").value = pl.diaSemana || "";
    document.getElementById("me-turno").value = pl.turno || "";
    document.getElementById("me-med1").value = pl.medico1 || "";
    document.getElementById("me-med2").value = pl.medico2 || "";
    document.getElementById("me-enf1").value = pl.enf1 || "";
    document.getElementById("me-enf2").value = pl.enf2 || "";
    document.getElementById("me-aux").value = pl.aux || "";
    document.getElementById("me-abertura").value = formatarDataHora(pl.abertura);
    document.getElementById("me-encerramento").value = formatarDataHora(pl.encerramento);
  }

  function preencherIndicadores(ind) {
    if (!ind) return;
    document.getElementById("kpi-alocados").textContent = ind.alocados || 0;
    document.getElementById("kpi-confirmadas").textContent = ind.reservasConfirmadas || 0;
    document.getElementById("kpi-canceladas").textContent = ind.reservasCanceladas || 0;
    document.getElementById("kpi-admitidos").textContent = ind.admitidosUIB || 0;
  }

  function atualizarStatus(pl) {
    const dot = document.getElementById("dotStatus");
    const text = document.getElementById("statusText");
    if (pl && pl.id) {
      dot.style.background = "#248a3d";
      text.textContent = "Plant√£o ativo";
    } else {
      dot.style.background = "#b25000";
      text.textContent = "Sem plant√£o ativo";
    }
  }

  function atualizarTitulosPrincipal(view) {
    const map = {
      confirmadas: {
        principal: "PACIENTES COM RESERVA CONFIRMADA",
        title: "Reservas Confirmadas",
        subtitle: "Pacientes com reserva confirmada para UIB"
      },
      vascular: {
        principal: "PACIENTES COM PROCEDIMENTO - VASCULAR",
        title: "Procedimentos Vasculares",
        subtitle: "Reservas vinculadas a procedimentos vasculares"
      },
      negadas: {
        principal: "PACIENTES COM RESERVA NEGADA",
        title: "Reservas Negadas",
        subtitle: "Reservas canceladas/negadas no plant√£o"
      },
      anterior: {
        principal: "PACIENTES COM RESERVA CONFIRMADA DO PLANT√ÉO ANTERIOR",
        title: "Plant√£o Anterior",
        subtitle: "Pacientes admitidos na UIB no plant√£o anterior"
      }
    };
    const cfg = map[view] || map.confirmadas;
    document.getElementById("tituloPrincipal").textContent = cfg.principal;
    document.getElementById("tableTitlePrincipal").textContent = cfg.title;
    document.getElementById("tableSubtitlePrincipal").textContent = cfg.subtitle;
  }

  function mudarView(btn) {
    const view = btn.getAttribute("data-view");
    estadoAtual.view = view;
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    btn.classList.add("active");
    carregarApp(view);
  }

  function abrirPlantao() {
    if (estadoAtual.plantaoAtivo) {
      alert("J√° existe um plant√£o ativo. Use 'Encerrar' para fechar ou 'Equipe do Plant√£o' para editar a equipe.");
      return;
    }

    document.getElementById("me-id").value = "";
    document.getElementById("me-data").value = "";
    document.getElementById("me-dia").value = "";
    document.getElementById("me-turno").value = "";
    document.getElementById("me-med1").value = "";
    document.getElementById("me-med2").value = "";
    document.getElementById("me-enf1").value = "";
    document.getElementById("me-enf2").value = "";
    document.getElementById("me-aux").value = "";
    document.getElementById("me-abertura").value = "";
    document.getElementById("me-encerramento").value = "";

    document.getElementById("modalEquipeBackdrop").classList.add("visible");
  }

  function encerrarPlantao() {
    if (!estadoAtual.plantaoAtivo) {
      alert("N√£o h√° plant√£o ativo para encerrar.");
      return;
    }
    if (!confirm("Encerrar o plant√£o atual e salvar no hist√≥rico?")) return;
    google.script.run
      .withSuccessHandler(function () {
        carregarApp();
      })
      .encerrarPlantao();
  }

  function salvarPlantao() {
    if (!estadoAtual.plantaoAtivo) {
      alert('Nenhum plant√£o ativo. Use "Abrir Plant√£o" para iniciar.');
      return;
    }

    const dados = {
      data: document.getElementById("me-data").value,
      diaSemana: document.getElementById("me-dia").value,
      turno: document.getElementById("me-turno").value,
      medico1: document.getElementById("me-med1").value,
      medico2: document.getElementById("me-med2").value,
      enf1: document.getElementById("me-enf1").value,
      enf2: document.getElementById("me-enf2").value,
      aux: document.getElementById("me-aux").value
    };

    setLoading(true, "Salvando equipe...");
    google.script.run
      .withSuccessHandler(function () {
        alert("Equipe do plant√£o salva.");
        carregarApp();
        setLoading(false);
      })
      .withFailureHandler(function (err) {
        console.error(err);
        alert("Erro ao salvar o plant√£o: " + err.message);
        setLoading(false);
      })
      .salvarPlantaoConfig(dados);
  }

  function renderEquipe(plantao) {
    const grid = document.getElementById("equipeGrid");
    const placeholder = document.getElementById("equipeSemPlantao");
    const statusChip = document.getElementById("equipeStatusChip");

    if (!grid || !placeholder || !statusChip) return;

    const setValor = (id, valor) => {
      const el = document.getElementById(id);
      if (el) el.textContent = valor || "-";
    };

    if (!plantao) {
      grid.classList.add("hidden");
      placeholder.classList.remove("hidden");
      statusChip.textContent = "Nenhum plant√£o ativo";
      statusChip.classList.remove("badge-success");
      return;
    }

    grid.classList.remove("hidden");
    placeholder.classList.add("hidden");
    statusChip.textContent = "Plant√£o ativo";

    setValor("eq-data", plantao.data || "-");
    setValor("eq-dia", plantao.dia || "-");
    setValor("eq-turno", plantao.turno || "-");
    setValor("eq-med1", plantao.med1 || "-");
    setValor("eq-med2", plantao.med2 || "-");
    setValor("eq-enf1", plantao.enf1 || "-");
    setValor("eq-enf2", plantao.enf2 || "-");
    setValor("eq-aux", plantao.aux || "-");
  }

  function abrirModalEquipeEdicao() {
    if (!estadoAtual.plantaoAtivo) {
      alert('Nenhum plant√£o ativo. Use "Abrir Plant√£o" para iniciar um novo plant√£o.');
      return;
    }
    document.getElementById("modalEquipeBackdrop").classList.add("visible");
  }

  function fecharModalEquipe() {
    document.getElementById("modalEquipeBackdrop").classList.remove("visible");
  }

  function salvarEquipeModal() {
    const dados = {
      data: document.getElementById("me-data").value,
      diaSemana: document.getElementById("me-dia").value,
      turno: document.getElementById("me-turno").value,
      medico1: document.getElementById("me-med1").value,
      medico2: document.getElementById("me-med2").value,
      enf1: document.getElementById("me-enf1").value,
      enf2: document.getElementById("me-enf2").value,
      aux: document.getElementById("me-aux").value
    };

    setLoading(true, estadoAtual.plantaoAtivo ? "Atualizando plant√£o..." : "Abrindo plant√£o...");
    if (!estadoAtual.plantaoAtivo) {
      google.script.run
        .withSuccessHandler(function () {
          fecharModalEquipe();
          carregarApp();
          setLoading(false);
        })
        .withFailureHandler(function (err) {
          console.error(err);
          alert("Erro ao abrir o plant√£o: " + err.message);
          setLoading(false);
        })
        .criarPlantaoComEquipe(dados);
    } else {
      google.script.run
        .withSuccessHandler(function () {
          fecharModalEquipe();
          carregarApp();
          setLoading(false);
        })
        .withFailureHandler(function (err) {
          console.error(err);
          alert("Erro ao salvar o plant√£o: " + err.message);
          setLoading(false);
        })
        .salvarPlantaoConfig(dados);
    }
  }

  function renderTabela(wrapperId, tabela, mostrarAcaoExcluir, moduloNome) {
    const wrapper = document.getElementById(wrapperId);
    wrapper.innerHTML = "";

    if (!tabela || !tabela.headers || tabela.headers.length === 0) {
      wrapper.innerHTML = '<div style="padding:8px 10px;font-size:12px;color:#6e6e73;">Nenhum dado cadastrado.</div>';
      return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    tabela.headers.forEach((h, idx) => {
      const th = document.createElement("th");
      th.textContent = h || `Col ${idx+1}`;
      trh.appendChild(th);
    });

    if (mostrarAcaoExcluir) {
      const thAcao = document.createElement("th");
      thAcao.textContent = "A√ß√£o";
      trh.appendChild(thAcao);
    }

    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    (tabela.rows || []).forEach(row => {
      const tr = document.createElement("tr");
      row.forEach((cell) => {
        const td = document.createElement("td");
        td.textContent = cell === null || cell === undefined ? "" : cell;
        tr.appendChild(td);
      });

      if (mostrarAcaoExcluir) {
        const tdAcao = document.createElement("td");
        const btn = document.createElement("button");
        btn.className = "btn-table";
        btn.textContent = "Excluir";
        const id = row[0];
        btn.onclick = function () {
          if (!id) {
            alert("Registro sem ID definido (primeira coluna).");
            return;
          }
          if (!confirm("Excluir esse registro?")) return;
          setLoading(true, "Excluindo registro...");
          google.script.run
            .withSuccessHandler(function () {
              carregarApp();
              setLoading(false);
            })
            .withFailureHandler(function (err) {
              console.error(err);
              alert("Erro ao excluir: " + err.message);
              setLoading(false);
            })
            .excluirRegistro(moduloNome, String(id));
        };
        tdAcao.appendChild(btn);
        tr.appendChild(tdAcao);
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrapper.appendChild(table);
  }

  function abrirModalRegistroPrincipal() {
    const modulo = viewToModulo[estadoAtual.view] || "RESERVA_CONFIRMADA";
    abrirModalRegistro(modulo);
  }

  function abrirModalRegistro(modulo) {
    estadoAtual.moduloRegistroAtual = modulo;
    const cfg = moduleConfig[modulo];
    if (!cfg) {
      alert("Formul√°rio n√£o configurado para: " + modulo);
      return;
    }

    document.getElementById("modalRegistroTitulo").textContent = cfg.titulo;
    const body = document.getElementById("modalRegistroBody");
    body.innerHTML = "";

    cfg.campos.forEach(campo => {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.textContent = campo.label;
      wrapper.appendChild(label);

      let input;
      if (campo.type === "textarea") {
        input = document.createElement("textarea");
      } else {
        input = document.createElement("input");
        input.type = campo.type;
      }
      input.id = "mr-" + campo.name;
      wrapper.appendChild(input);

      body.appendChild(wrapper);
    });

    document.getElementById("modalRegistroBackdrop").classList.add("visible");
  }

  function fecharModalRegistro() {
    document.getElementById("modalRegistroBackdrop").classList.remove("visible");
    estadoAtual.moduloRegistroAtual = null;
  }

  function salvarRegistroModal() {
    const modulo = estadoAtual.moduloRegistroAtual;
    if (!modulo) {
      fecharModalRegistro();
      return;
    }

    const cfg = moduleConfig[modulo];
    const registro = {};
    cfg.campos.forEach(campo => {
      const el = document.getElementById("mr-" + campo.name);
      registro[campo.name] = el ? el.value : "";
    });

    setLoading(true, "Salvando registro...");
    google.script.run
      .withSuccessHandler(function () {
        fecharModalRegistro();
        carregarApp();
        setLoading(false);
      })
      .withFailureHandler(function (err) {
        console.error(err);
        alert("Erro ao salvar: " + err.message);
        setLoading(false);
      })
      .adicionarRegistro(modulo, registro);
  }

  document.addEventListener("DOMContentLoaded", function () {
    selecionarMenu("painel-ocorrencias");
  });
</script>

</body>
</html>
